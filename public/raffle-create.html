<!DOCTYPE html>
<html class="dark" lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Crear Rifa ‚Ä¢ Telegram Game Room</title>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script>tailwind.config={darkMode:'class',theme:{extend:{colors:{primary:'#06e4f9','background-dark':'#0B0E14',accent:'#22d3ee',card:'#121A2B',text:'#E6EDF3',glass:'rgba(255,255,255,.1)'}}}};</script>
  <style>body{min-height:max(884px,100dvh)}</style>
</head>
<body class="bg-background-dark font-display text-text">
  <div class="min-h-screen bg-background-dark relative">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
    <div id="sheetOverlay" class="relative z-10 min-h-screen flex flex-col">
      <main class="flex-1"></main>
      <section class="pb-6 px-4">
        <div id="createSheet" class="relative max-w-md mx-auto bg-card border border-glass rounded-t-2xl rounded-b-xl p-5 space-y-4 shadow-neon-accent">
          <button id="closeCreateSheet" class="absolute top-3 right-3 w-9 h-9 rounded-full border border-glass flex items-center justify-center text-text/70 hover:text-text hover:border-accent transition" aria-label="Cerrar">
            <span class="material-symbols-outlined">close</span>
          </button>
        <h1 class="text-xl font-bold text-center">Crear rifa</h1>
        <div>
          <label class="text-sm" for="name">Nombre</label>
          <input id="name" class="w-full bg-background-dark border border-glass rounded-lg p-3" placeholder="Nombre corto"/>
        </div>
        <div class="grid grid-cols-3 gap-2">
          <label class="flex items-center justify-center p-3 border border-glass rounded-lg cursor-pointer has-[:checked]:bg-accent/20 has-[:checked]:border-accent">
            <input type="radio" name="mode" id="mode_fire" value="fire" class="hidden" checked>
            <span class="font-medium">Fuego</span>
          </label>
          <label class="flex items-center justify-center p-3 border border-glass rounded-lg cursor-pointer has-[:checked]:bg-accent/20 has-[:checked]:border-accent">
            <input type="radio" name="mode" id="mode_prize" value="prize" class="hidden">
            <span class="font-medium">Premio</span>
          </label>
          <label class="hidden flex items-center justify-center p-3 border border-glass rounded-lg cursor-pointer has-[:checked]:bg-accent/20 has-[:checked]:border-accent">
            <input type="radio" name="mode" id="mode_free" value="free" class="hidden">
            <span class="font-medium">Libre</span>
          </label>
        </div>

        <div id="fireFields" class="space-y-3">
          <div>
            <label class="text-sm" for="entry">Fuegos por n√∫mero (min 10)</label>
            <input id="entry" type="number" min="10" value="10" class="w-full bg-background-dark border border-glass rounded-lg p-3"/>
          </div>
        </div>

        <div id="prizeFields" class="space-y-3 hidden">
          <div class="text-sm text-text/70">Costo de creaci√≥n: 200 üî•</div>
          <div class="grid grid-cols-1 gap-3">
            <input id="host_name" class="w-full bg-background-dark border border-glass rounded-lg p-3" placeholder="Tu nombre"/>
            <input id="host_phone" class="w-full bg-background-dark border border-glass rounded-lg p-3" placeholder="Tel√©fono"/>
            <input id="host_email" class="w-full bg-background-dark border border-glass rounded-lg p-3" placeholder="Correo"/>
            <input id="prize_name" class="w-full bg-background-dark border border-glass rounded-lg p-3" placeholder="Premio"/>
            <div class="grid grid-cols-3 gap-2">
              <input id="pay_id" class="bg-background-dark border border-glass rounded-lg p-3" placeholder="C√©dula"/>
              <input id="pay_phone" class="bg-background-dark border border-glass rounded-lg p-3" placeholder="Tel√©fono"/>
              <select id="pay_bank" class="bg-background-dark border border-glass rounded-lg p-3">
                <option value="">Banco</option>
                <option value="0102" data-name="Banco de Venezuela">0102 - Banco de Venezuela</option>
                <option value="0104" data-name="Banco Venezolano de Cr√©dito">0104 - Banco Venezolano de Cr√©dito</option>
                <option value="0105" data-name="Banco Mercantil">0105 - Banco Mercantil</option>
                <option value="0108" data-name="BBVA Provincial">0108 - BBVA Provincial</option>
                <option value="0114" data-name="Banco del Caribe">0114 - Banco del Caribe</option>
                <option value="0115" data-name="Banco Exterior">0115 - Banco Exterior</option>
                <option value="0116" data-name="Banco Occidental de Descuento">0116 - Banco Occidental de Descuento</option>
                <option value="0128" data-name="Banco Caron√≠">0128 - Banco Caron√≠</option>
                <option value="0134" data-name="Banesco">0134 - Banesco</option>
                <option value="0137" data-name="Banco Sofitasa">0137 - Banco Sofitasa</option>
                <option value="0138" data-name="Banco Plaza">0138 - Banco Plaza</option>
                <option value="0156" data-name="100% Banco">0156 - 100% Banco</option>
                <option value="0157" data-name="DelSur Banco Universal">0157 - DelSur Banco Universal</option>
                <option value="0163" data-name="Banco del Tesoro">0163 - Banco del Tesoro</option>
                <option value="0166" data-name="Banco Agr√≠cola de Venezuela">0166 - Banco Agr√≠cola de Venezuela</option>
                <option value="0168" data-name="Bancrecer">0168 - Bancrecer</option>
                <option value="0169" data-name="Mi Banco">0169 - Mi Banco</option>
                <option value="0171" data-name="Banco Activo">0171 - Banco Activo</option>
                <option value="0172" data-name="Bancamiga">0172 - Bancamiga</option>
                <option value="0174" data-name="Banplus">0174 - Banplus</option>
                <option value="0175" data-name="Banco Bicentenario">0175 - Banco Bicentenario</option>
                <option value="0177" data-name="BANFANB">0177 - Banco de la Fuerza Armada Nacional Bolivariana (BANFANB)</option>
                <option value="0190" data-name="CITIBANK">0190 - CITIBANK</option>
                <option value="0191" data-name="Banco Nacional de Cr√©dito">0191 - Banco Nacional de Cr√©dito</option>
              </select>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm">Visibilidad</label>
            <select id="visibility" class="w-full bg-background-dark border border-glass rounded-lg p-3"><option value="public">P√∫blica</option><option value="private">Privada</option></select>
          </div>
          <div>
            <label class="text-sm">Rango</label>
            <select id="range" class="w-full bg-background-dark border border-glass rounded-lg p-3"><option value="00-99">00-99</option><option value="000-999">000-999</option></select>
          </div>
        </div>
        <div>
          <label class="text-sm">Tiempo</label>
          <select id="time" class="w-full bg-background-dark border border-glass rounded-lg p-3"><option>Ganador</option><option>1 d√≠a</option><option>1 semana</option></select>
        </div>
        <button id="createBtn" class="w-full bg-accent text-background-dark font-bold py-3 rounded-lg">Crear</button>
      </div>
      </section>
    </div>
  </div>
<script>
(function(){
  function me(){ const tg=window.Telegram&&window.Telegram.WebApp; const u=tg&&tg.initDataUnsafe&&tg.initDataUnsafe.user; if(!u){let x=localStorage.getItem('anon_uid'); if(!x){x='anon:'+Math.random().toString(36).slice(2,8); localStorage.setItem('anon_uid',x);} return { id:x, name:'Invitado' }; } return { id:'tg:'+u.id, name:(u.username||[u.first_name,u.last_name].filter(Boolean).join(' ')) } }
  const fire=document.getElementById('mode_fire'); const prize=document.getElementById('mode_prize');
  const fireFields=document.getElementById('fireFields'); const prizeFields=document.getElementById('prizeFields');
  function toggle(){
    if (prize.checked){ prizeFields.classList.remove('hidden'); fireFields.classList.add('hidden'); }
    else { prizeFields.classList.add('hidden'); fireFields.classList.remove('hidden'); }
  }
  fire.addEventListener('change',toggle); prize.addEventListener('change',toggle);
  toggle();
  function closeSheet(){ window.location.href = '/raffles'; }
  const closeBtn = document.getElementById('closeCreateSheet');
  if (closeBtn) closeBtn.addEventListener('click', closeSheet);
  const overlay = document.getElementById('sheetOverlay');
  const sheet = document.getElementById('createSheet');
  if (overlay) overlay.addEventListener('click', (ev)=>{ try{ if (sheet && !sheet.contains(ev.target)) closeSheet(); }catch(_){ } });
  document.getElementById('createBtn').addEventListener('click', async()=>{
    const u=me();
    const mode = prize.checked ? 'prize' : 'fire';
    const entryPrice = prize.checked ? 200 : Math.max(10, parseInt(document.getElementById('entry').value||'10',10));
    const payload = {
      hostId: u.id, hostName: u.name,
      name: String(document.getElementById('name').value||'').trim(),
      mode, entryPrice,
      visibility: document.getElementById('visibility').value,
      range: document.getElementById('range').value,
      time: document.getElementById('time').value
    };
    if (mode==='prize'){
      const bankEl = document.getElementById('pay_bank');
      const bankCode = bankEl ? bankEl.value : '';
      const bankName = bankEl && bankEl.selectedOptions && bankEl.selectedOptions[0] ? (bankEl.selectedOptions[0].dataset.name||'') : '';
      payload.hostMeta = {
        name: document.getElementById('host_name').value,
        phone: document.getElementById('host_phone').value,
        email: document.getElementById('host_email').value,
        pay: { id: document.getElementById('pay_id').value, phone: document.getElementById('pay_phone').value, bank: bankCode, bankCode, bankName }
      };
      payload.prizeMeta = { prize: document.getElementById('prize_name').value };
    }
    try{
      const r = await fetch('/api/raffles/create',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const j = await r.json();
      if (j&&j.success && j.raffle){ window.location.href = '/raffles/room?code=' + encodeURIComponent(j.raffle.code); }
      else { alert('No se pudo crear la rifa: ' + (j&&j.error||'error')); }
    }catch(_){ alert('Error de red'); }
  });
})();
</script>
<script src="/js/footer-nav.js"></script>
<script src="/js/music.js"></script>
</body>
</html>
