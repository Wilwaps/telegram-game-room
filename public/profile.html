<!DOCTYPE html>
<html class="dark" lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Perfil • Telegram Game Room</title>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="/js/app-user.js"></script>
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#06e4f9',
            'background-light': '#f5f8f8',
            'background-dark': '#0B0E14',
            violet: '#a78bfa',
            accent: '#22d3ee',
            card: '#121A2B',
            text: '#E6EDF3',
            glass: 'rgba(255, 255, 255, 0.1)'
          },
          fontFamily: { display: ['Space Grotesk'] },
          borderRadius: { DEFAULT: '0.5rem', lg: '0.75rem', xl: '1rem', full: '9999px' }
        }
      }
    };
  </script>
  <style>
    body { min-height: max(884px, 100dvh); }
    .nav-item:hover { background-color: var(--tw-bg-accent); color: var(--tw-bg-background-dark); }
    .nav-item { transition: background-color 0.2s, color 0.2s; }
    .nav-item .material-symbols-outlined { display:block; margin:0 auto 0.25rem; }
    .fire-btn { cursor:pointer; display:inline-flex; align-items:center; gap:0.5rem; padding:0.25rem 0.5rem; border-radius:9999px; }
    .fire-btn .material-symbols-outlined { color:#fb923c; filter: drop-shadow(0 0 6px rgba(251, 146, 60, 0.55)); animation: firePulse 2.8s ease-in-out infinite; }
    @keyframes firePulse { 0%,100% { filter: drop-shadow(0 0 6px rgba(251,146,60,.55)); } 50% { filter: drop-shadow(0 0 14px rgba(251,146,60,.9)); } }
    .overlay { position:fixed; inset:0; z-index:50; display:none; }
    .overlay.show { display:flex; }
    .inbox-btn { position: relative; cursor: pointer; }
    .inbox-dot { position:absolute; top:-4px; right:-4px; width:10px; height:10px; background:#ef4444; border-radius:9999px; box-shadow:0 0 8px rgba(239,68,68,.8); display:none; }
    .inbox-btn.blink .material-symbols-outlined { color:#ef4444; filter: drop-shadow(0 0 8px rgba(239,68,68,.8)); animation: inboxPulse 2.2s ease-in-out infinite; }
    @keyframes inboxPulse { 0%,100% { filter: drop-shadow(0 0 6px rgba(239,68,68,.5)); } 50% { filter: drop-shadow(0 0 14px rgba(239,68,68,.95)); } }
  </style>
</head>
<body class="bg-background-dark font-display text-text">
<!-- Overlay: Historial de Fuegos -->
<div id="firesHistoryOverlay" class="overlay bg-black/50 backdrop-blur-sm p-4 justify-end">
  <div class="bg-card rounded-xl flex flex-col max-w-md mx-auto w-full border border-glass">
    <div class="p-4 border-b border-glass flex items-center justify-between">
      <h2 class="text-xl font-bold text-center flex-1">Balance de Fuegos</h2>
      <button id="closeHistory" class="text-text/70 hover:text-text"><span class="material-symbols-outlined">close</span></button>
    </div>
    <div class="flex-1 p-4 space-y-3 overflow-y-auto" id="firesHistoryList">
      <!-- items dinamicos -->
    </div>
    <div class="p-4 grid grid-cols-3 gap-3 items-center">
      <button id="sendFiresBtn" class="w-full bg-violet/80 text-text font-bold py-3 rounded-lg hover:bg-violet transition-colors">Enviar</button>
      <button id="buyFiresBtn" class="w-full bg-accent text-background-dark font-bold py-4 rounded-lg hover:opacity-90 transition-opacity">Comprar</button>
      <button id="receiveFiresBtn" class="w-full bg-violet/80 text-text font-bold py-3 rounded-lg hover:bg-violet transition-colors">Recibir</button>
    </div>
  </div>

  <!-- Overlay: Bienvenida (evento) -->
  <div id="welcomeOverlay" class="overlay items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
    <div class="bg-card rounded-xl flex flex-col max-w-md mx-auto w-full shadow-lg border border-glass overflow-hidden">
      <div class="p-5 bg-gradient-to-r from-amber-500/20 to-accent/20 border-b border-glass text-center">
        <div class="text-2xl font-extrabold">Regalo de Bienvenida</div>
        <div id="welcomeMsg" class="text-sm text-text/80 mt-1"></div>
      </div>
      <div class="p-6 text-center space-y-4">
        <div class="flex items-center justify-center gap-6">
          <div class="flex items-center gap-2">
            <span class="material-symbols-outlined text-violet text-3xl">monetization_on</span>
            <span id="welCoins" class="text-3xl font-extrabold">0</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="material-symbols-outlined text-orange-400 text-3xl" style="font-variation-settings:'FILL' 1;">local_fire_department</span>
            <span id="welFires" class="text-3xl font-extrabold">0</span>
          </div>
        </div>
        <div id="welUntil" class="text-xs text-text/60"></div>
        <button id="welcomeOk" class="w-full bg-accent text-background-dark font-bold py-3 rounded-lg hover:opacity-90 transition-opacity">¡Entendido!</button>
      </div>
    </div>
  </div>
</div>

<!-- Overlay: Comprar Fuegos -->
<div id="buyFiresOverlay" class="overlay items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
  <div class="bg-card rounded-xl flex flex-col max-w-md mx-auto w-full shadow-lg border border-glass">
    <div class="p-4 border-b border-glass flex items-center justify-between">
      <h2 class="text-xl font-bold text-center text-accent flex-1">Comprar Fuegos</h2>
      <button id="closeBuy" class="text-text/70 hover:text-text"><span class="material-symbols-outlined">close</span></button>
    </div>
    <div class="p-6 space-y-6">
      <div class="bg-background-dark rounded-lg p-3 text-center border border-glass">
        <p class="text-sm text-text/70 mb-1">Balance Actual de Fuegos</p>
        <div class="flex items-center justify-center space-x-2">
          <span id="currentFiresVal" class="text-2xl font-bold text-orange-400">0</span>
          <span class="material-symbols-outlined text-orange-400 text-2xl" style="font-variation-settings: 'FILL' 1;">local_fire_department</span>
        </div>
      </div>
      <div class="space-y-2">
        <label class="font-semibold text-text/80" for="fire-amount">Cantidad de Fuegos</label>
        <div class="relative">
          <input class="w-full bg-background-dark border border-glass rounded-lg p-3 pl-10 text-text focus:ring-accent focus:border-accent" id="fire-amount" placeholder="0" type="number"/>
          <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-orange-400" style="font-variation-settings: 'FILL' 1;">local_fire_department</span>
          <button id="pasteAmount" class="absolute right-2 top-1/2 -translate-y-1/2 text-xs bg-glass hover:bg-accent/20 px-2 py-1 rounded-lg">Pegar</button>
        </div>
      </div>
      <div class="space-y-2">
        <label class="font-semibold text-text/80" for="transaction-ref">Referencia de Transacción</label>
        <div class="relative">
          <input class="w-full bg-background-dark border border-glass rounded-lg p-3 text-text focus:ring-accent focus:border-accent" id="transaction-ref" placeholder="Ingrese la referencia del pago" type="text"/>
          <button id="pasteRef" class="absolute right-2 top-1/2 -translate-y-1/2 text-xs bg-glass hover:bg-accent/20 px-2 py-1 rounded-lg">Pegar</button>
        </div>
      </div>
    </div>
    <div class="p-4 space-y-4">
      <button id="copyData" class="w-full bg-violet text-background-dark font-bold py-3 rounded-lg hover:opacity-90 transition-opacity">Copiar Datos</button>
      <button id="acceptBuy" class="w-full bg-accent text-background-dark font-bold py-3 rounded-lg hover:opacity-90 transition-opacity">Aceptar</button>
    </div>
  </div>
</div>

<!-- Overlay: Bandeja de entrada -->
<div id="inboxOverlay" class="overlay items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
  <div class="bg-card rounded-xl flex flex-col max-w-md mx-auto w-full shadow-lg border border-glass">
    <div class="p-4 border-b border-glass flex items-center justify-between">
      <h2 class="text-xl font-bold text-center flex-1">Mensajes</h2>
      <button id="closeInbox" class="text-text/70 hover:text-text"><span class="material-symbols-outlined">close</span></button>
    </div>
    <div id="inboxList" class="p-4 max-h-[60vh] overflow-y-auto space-y-2 text-sm"></div>
  </div>
</div>

<div class="flex flex-col min-h-screen">
  <main class="flex-1 p-4 pb-24">
    <div class="flex flex-col items-center space-y-6">
      <div id="greet" class="w-full max-w-md text-center text-sm text-text/90 bg-card border border-glass rounded-lg p-2" style="display:none"></div>
      <div class="relative flex flex-col items-center gap-3">
        <img alt="User profile image" class="w-32 h-32 rounded-full border-2 border-glass" src="https://lh3.googleusercontent.com/aida-public/AB6AXuBcO4sAoIKsqz6c_1ao9l8oLKrRoHcgQgvKXMVZ1GjrD6yIt1wIHUoUejWNVg5YeFSUNG2AzXPMsQBpnk9JKm7nj3Fl0c_-Jqff4R7sYxnLt9HXJtqXN5mHa4LpYy8ze_U0XA5E_p63z6cQCqLqyvstKocyRXYEASAUSo6DzvZTIfgZsyx7Xqbw8vV7RblR_FBppp7LTCsFU7QanKpaRmqO3o8B9Vxmy_1-jF73jvsjIbKoT9uvlznwhPR06j9c8xcPEZp403DWuA_j"/>
        <div class="flex items-center gap-2 bg-card/60 border border-glass rounded-full px-4 py-1">
          <span id="profileName" class="text-lg font-bold text-text"></span>
          <button id="copyPlatformId" class="flex items-center gap-1 text-xs font-semibold text-accent hover:text-primary transition-colors" title="Copiar ID plataforma">
            <span class="material-symbols-outlined text-base">content_copy</span>
            <span>Copiar</span>
          </button>
        </div>
        <div id="platformIdLabel" class="text-xs text-text/60"></div>
        <div id="copyToast" class="hidden text-xs text-text/80 bg-glass px-3 py-1 rounded-full">ID copiado</div>
      </div>

      <div class="bg-card rounded-lg p-4 w-full max-w-md bg-gradient-to-br from-card to-accent/10">
        <div class="flex justify-around items-center">
          <button id="fireBtn" class="fire-btn">
            <span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">local_fire_department</span>
            <span id="firesVal" class="font-bold text-lg">0</span>
          </button>
          <div class="flex items-center space-x-2">
            <span class="material-symbols-outlined text-violet">monetization_on</span>
            <span id="coinsVal" class="font-bold text-lg">0</span>
          </div>
          <div class="flex items-center space-x-2">
            <span id="expVal" class="font-bold text-lg">0</span>
            <span class="text-sm">EXP</span>
            <button id="inboxBtn" class="inbox-btn ml-1"><span class="material-symbols-outlined text-accent">mail</span><span id="inboxDot" class="inbox-dot"></span></button>
          </div>
        </div>
      </div>

      <div class="w-full max-w-md space-y-3">
        <a class="block w-full bg-accent text-background-dark font-bold py-3 rounded-lg hover:opacity-90 transition-opacity text-center" href="#">Datos Personales</a>
        <a class="block w-full bg-primary text-background-dark font-bold py-3 rounded-lg hover:opacity-90 transition-opacity text-center" href="#">Avance y logros</a>
      </div>

      <div class="bg-card rounded-lg p-4 w-full max-w-md bg-gradient-to-br from-card to-accent/10">
        <h3 class="font-bold text-lg mb-3 text-center">Estadísticas de Juego</h3>
        <div class="grid grid-cols-3 gap-2 text-center">
          <div>
            <p class="text-xs text-text/70">Victorias</p>
            <p id="winsVal" class="font-bold text-xl">0</p>
          </div>
          <div>
            <p class="text-xs text-text/70">Empates</p>
            <p id="drawsVal" class="font-bold text-xl">0</p>
          </div>
          <div>
            <p class="text-xs text-text/70">Derrotas</p>
            <p id="lossesVal" class="font-bold text-xl">0</p>
          </div>
        </div>
      </div>

      <div class="w-full max-w-md pt-4 space-y-3">
        <button class="w-full bg-gradient-to-r from-orange-500 to-yellow-400 text-text font-bold py-3 rounded-lg hover:opacity-90 transition-opacity">
          Fuego Canjeado
        </button>
        <button id="fireReqAdminBtn" class="w-full bg-violet text-background-dark font-bold py-3 rounded-lg hover:opacity-90 transition-opacity" style="display:none;">
          Fuegos Pedidos
        </button>
      </div>
    </div>
  </main>
</div>
<script>
  (function(){
    const $ = (id) => document.getElementById(id);
    const fmt = (n) => new Intl.NumberFormat().format(n ?? 0);
    const nameEl = $('profileName');
    const platformIdEl = $('platformIdLabel');
    const copyBtn = $('copyPlatformId');
    const copyToast = $('copyToast');
    function hash10(str){ try{ let h=2166136261>>>0; const s=String(str||''); for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619)>>>0; } const d=String(h); return d.length>=10?d.slice(0,10):d.padStart(10,'0'); }catch(_){ return '0000000000'; } }
    function platformId(uid){ return hash10(uid); }
    function fallbackName(uid){ const pid = platformId(uid); return `User ${pid.slice(-6)}`; }
    function resolveDisplayName(data){
      if(!data) return '';
      const uid = String(data.userId||'');
      const nm = String(data.userName||'').trim();
      if (nm && !/^anon:/i.test(nm) && nm !== uid) return nm;
      return fallbackName(uid);
    }
    function renderProfileHeader(data){ if(!data) return; const uid = String(data.userId||''); const pid = platformId(uid); const displayName = resolveDisplayName(data); if (nameEl) nameEl.textContent = displayName; if (platformIdEl) platformIdEl.textContent = pid ? `ID Plataforma: ${pid}` : ''; if (copyBtn) { copyBtn.dataset.pid = pid; copyBtn.disabled = !pid; } }
    function showToast(){ if(!copyToast) return; copyToast.classList.remove('hidden'); clearTimeout(showToast._timer); showToast._timer = setTimeout(()=>{ copyToast.classList.add('hidden'); }, 1500); }
    let uid = null;
    let profileSnap = null;
    let unread = 0;
    function show(el){ el && el.classList.add('show'); }
    function hide(el){ el && el.classList.remove('show'); }
    function mapFireTx(item){
      const t=item?.type||''; const amt=Number(item?.amount||0);
      let sign=''; let cls='text-text/80'; let label='';
      if (t==='fires_spend') { sign='-'; cls='text-error'; label='Gasto'; }
      else if (t==='grant' || t==='transfer' || t==='fire_request_accept') { sign='+'; cls='text-success'; label=t==='transfer'?'Transferencia':'Crédito'; }
      else if (t==='fire_request_create') { sign=''; cls='text-text/70'; label='Solicitud'; }
      else if (t==='fire_request_reject') { sign=''; cls='text-error'; label='Rechazada'; }
      else { return null; }
      return { sign, cls, label, amt, reason: item?.reason||item?.reference||'', ts: item?.ts||Date.now() };
    }
    function relTime(ts){ try{ const d=Date.now()-Number(ts||0); if (d<60000) return 'Ahora'; if (d<3600000) return Math.floor(d/60000)+' min'; if (d<86400000) return Math.floor(d/3600000)+' h'; return new Date(ts).toLocaleDateString(); }catch(_){ return '' } }
    async function loadProfile(){
      const tg = window.Telegram && window.Telegram.WebApp;
      const user = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;
      try { if (window.AppUser && typeof window.AppUser.resolveUserId==='function') { uid = window.AppUser.resolveUserId(); } } catch(_){ }
      if (!uid) {
        // Fallback anónimo para QA fuera de Telegram
        uid = localStorage.getItem('anon_uid');
        if (!uid) { uid = 'anon:' + Math.random().toString(36).slice(2,8); localStorage.setItem('anon_uid', uid); }
      }
      const uname = (user && (user.username || [user.first_name, user.last_name].filter(Boolean).join(' ').trim())) || 'Invitado';
      const r = await fetch(`/api/profile/${encodeURIComponent(uid)}`);
      const j = await r.json();
      if (j && j.success && j.user) {
        profileSnap = j.user;
        const fires = Number(j.user.fires||0);
        const coins = Number(j.user.coins||0);
        const earned = Number(j.user.earnedCoins||0);
        renderProfileHeader(profileSnap);
        const exp = Number(j.user.exp||0);
        const fEl = $('firesVal'); if (fEl) fEl.textContent = fmt(fires);
        const cEl = $('coinsVal'); if (cEl) cEl.textContent = fmt(coins);
        const eEl = $('expVal'); if (eEl) eEl.textContent = fmt(exp);
        const greet = $('greet'); if (greet && user) { greet.style.display='block'; greet.textContent = `¡Felicidades ${uname}! Has ganado ${fmt(earned)} monedas en el grupo.`; }
        const st = (j.user && j.user.stats) ? j.user.stats : { wins:0, draws:0, losses:0 };
        const wEl = $('winsVal'); if (wEl) wEl.textContent = fmt(st.wins||0);
        const dEl = $('drawsVal'); if (dEl) dEl.textContent = fmt(st.draws||0);
        const lEl = $('lossesVal'); if (lEl) lEl.textContent = fmt(st.losses||0);
        const cur = $('currentFiresVal'); if (cur) cur.textContent = String(fires);
      }
    }
    async function checkWelcomeBanner(){
      try{
        const r = await fetch('/api/welcome/status');
        const j = await r.json();
        if (!(j&&j.success&&j.event)) return;
        const ev = j.event; const now = Date.now();
        if (!ev.active || now>Number(ev.endsAt||0)) return;
        const key = 'welcome_shown_'+String(ev.endsAt||'');
        if (localStorage.getItem(key)) return;
        const msg = String(ev.message||'¡Reclama tu bono por bienvenida!');
        document.getElementById('welcomeMsg').textContent = msg;
        document.getElementById('welCoins').textContent = new Intl.NumberFormat().format(ev.coins||0);
        document.getElementById('welFires').textContent = new Intl.NumberFormat().format(ev.fires||0);
        document.getElementById('welUntil').textContent = 'Válido hasta: '+ new Date(ev.endsAt).toLocaleString();
        show(document.getElementById('welcomeOverlay'));
        const btn = document.getElementById('welcomeOk');
        btn.onclick = ()=>{ hide(document.getElementById('welcomeOverlay')); localStorage.setItem(key,'1'); };
      }catch(_){ }
    }
    async function loadFireHistory(){
      if (!uid) return;
      const cont = $('firesHistoryList'); if (!cont) return; cont.innerHTML='';
      let j=null; try { const r=await fetch(`/api/economy/history/${encodeURIComponent(uid)}?limit=50`); j=await r.json(); } catch(_){ }
      const items=(j&&j.success&&Array.isArray(j.items))?j.items:[];
      const mapped = items.map(mapFireTx).filter(Boolean);
      if (mapped.length===0){ cont.innerHTML = '<div class="text-center text-text/60 text-sm">Sin movimientos</div>'; return; }
      for (const it of mapped){
        const row=document.createElement('div');
        row.className='bg-background-dark p-3 rounded-lg';
        row.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <p class="font-bold ${it.cls}">${it.sign} ${it.amt} Fuegos</p>
              <p class="text-xs text-text/70">${it.label}${it.reason?(' · '+it.reason):''}</p>
            </div>
            <span class="text-sm text-text/50">${relTime(it.ts)}</span>
          </div>
          <div class="hidden mt-2 text-xs text-text/70">
            <div>Tipo: ${it.label}</div>
            <div>Motivo/Ref: ${it.reason||'-'}</div>
            <div>Fecha: ${new Date(it.ts).toLocaleString()}</div>
          </div>
        `;
        row.addEventListener('click', ()=>{
          const det = row.querySelector('div.hidden');
          if (det) { det.classList.toggle('hidden'); }
        });
        cont.appendChild(row);
      }
    }
    async function createFireRequest(){
      const amt = Number(($('fire-amount')?.value||'0'))||0;
      const ref = String(($('transaction-ref')?.value||'').trim());
      if (!uid || amt<=0 || !ref){ alert('Ingresa cantidad y referencia válidas'); return; }
      try {
        const r = await fetch('/api/economy/fire-requests/create',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: uid, amount: amt, reference: ref }) });
        const j = await r.json();
        if (j && j.success){ alert('Solicitud enviada. Espera aprobación.'); hide($('buyFiresOverlay')); show($('firesHistoryOverlay')); await loadFireHistory(); }
        else { alert('No se pudo crear la solicitud'); }
      } catch(_){ alert('Error de red'); }
    }
    async function loadInboxUnread(){
      if (!uid) return;
      try{
        const r = await fetch(`/api/messages/unread-count/${encodeURIComponent(uid)}`);
        const j = await r.json();
        unread = (j&&j.success) ? Number(j.count||0) : 0;
      }catch(_){ unread = 0; }
      const dot = $('inboxDot'); const btn=$('inboxBtn');
      if (unread>0){ if(dot) dot.style.display='block'; btn&&btn.classList.add('blink'); }
      else { if(dot) dot.style.display='none'; btn&&btn.classList.remove('blink'); }
    }
    async function openInbox(){
      if (!uid) return;
      try{
        const r = await fetch(`/api/messages/inbox/${encodeURIComponent(uid)}?limit=50`);
        const j = await r.json();
        const cont = $('inboxList');
        cont.innerHTML='';
        const items = (j&&j.success&&Array.isArray(j.items))?j.items:[];
        if (items.length===0){ cont.innerHTML='<div class="text-center text-text/60">Sin mensajes</div>'; }
        for (const m of items){
          const el=document.createElement('div');
          el.className='bg-background-dark border border-glass rounded-lg p-2';
          const meta = m && m.meta || {};
          const isOffer = String(meta.type||'') === 'welcome_offer';
          const btnHtml = isOffer ? `<div class="mt-2"><button class="accept-offer px-3 py-1 bg-accent text-background-dark rounded-lg text-sm" data-event-id="${meta.eventId||''}">Aceptar bono</button></div>` : '';
          el.innerHTML=`<div class="text-xs text-text/50">${new Date(m.ts).toLocaleString()}</div><div>${m.text||''}</div>${btnHtml}`;
          if (isOffer){
            const b = el.querySelector('.accept-offer');
            if (b){
              b.addEventListener('click', async ()=>{
                try{
                  b.disabled = true;
                  const evId = b.getAttribute('data-event-id') || (meta.eventId||null);
                  const resp = await fetch('/api/welcome/accept',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: uid, eventId: evId }) });
                  const jj = await resp.json();
                  if (resp.ok && jj && jj.success){
                    b.textContent = 'Aceptado';
                    try{ await loadProfile(); }catch(_){ }
                    hide($('inboxOverlay'));
                  } else {
                    b.disabled = false;
                    alert('No se pudo activar el bono');
                  }
                }catch(_){ b.disabled=false; alert('Error de red'); }
              });
            }
          }
          cont.appendChild(el);
        }
        await fetch('/api/messages/read-all',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: uid }) });
        unread=0;
        const dot=$('inboxDot'); const btn=$('inboxBtn');
        if(dot) dot.style.display='none';
        btn&&btn.classList.remove('blink');
        show($('inboxOverlay'));
      }catch(_){ }
    }
        
    
    $('fireBtn')?.addEventListener('click', async ()=>{ await loadFireHistory(); show($('firesHistoryOverlay')); });
    $('closeHistory')?.addEventListener('click', ()=> hide($('firesHistoryOverlay')));
    $('buyFiresBtn')?.addEventListener('click', ()=>{ hide($('firesHistoryOverlay')); show($('buyFiresOverlay')); });
    $('closeBuy')?.addEventListener('click', ()=> hide($('buyFiresOverlay')));
    $('acceptBuy')?.addEventListener('click', createFireRequest);
    $('copyData')?.addEventListener('click', async ()=>{
      const txt = [
        '0102 Venezuela',
        '20827955',
        '04122250016',
        'Pago'
      ].join('\n');
      try { await navigator.clipboard.writeText(txt); alert('Datos copiados'); } catch(_){ alert('No se pudo copiar'); }
    });
    $('pasteAmount')?.addEventListener('click', async ()=>{
      try { const t = await navigator.clipboard.readText(); const n = parseInt(String(t).replace(/[^0-9]/g,''),10); if (!isNaN(n)) { $('fire-amount').value = String(n); } else { alert('El portapapeles no contiene un número'); } } catch(_){ alert('Permiso de portapapeles denegado'); }
    });
    $('pasteRef')?.addEventListener('click', async ()=>{
      try { const t = await navigator.clipboard.readText(); $('transaction-ref').value = String(t||'').trim(); } catch(_){ alert('Permiso de portapapeles denegado'); }
    });
    $('inboxBtn')?.addEventListener('click', openInbox);
    $('closeInbox')?.addEventListener('click', ()=> hide($('inboxOverlay')));
    copyBtn?.addEventListener('click', async ()=>{
      try{
        const pid = copyBtn.dataset.pid || '';
        if (!pid) return;
        await navigator.clipboard.writeText(pid);
        showToast();
      }catch(_){ alert('No se pudo copiar el ID'); }
    });
    let __profileBooted = false;
    let __inboxTimer = null;
    async function boot(){
      try{
        if (__profileBooted) { return; }
        __profileBooted = true;
        await Promise.all([
          (async()=>{ try{ await loadProfile(); }catch(_){ } })(),
          (async()=>{ try{ await loadInboxUnread(); }catch(_){ } })(),
          (async()=>{ try{ await checkWelcomeBanner(); }catch(_){ } })()
        ]);
        try { if (!__inboxTimer) { __inboxTimer = setInterval(loadInboxUnread, 10000); } } catch(_){ }
        try {
          let allow = false;
          try {
            const r = await fetch('/api/roles/me');
            const j = await r.json();
            const roles = (j && j.success && Array.isArray(j.roles)) ? j.roles : [];
            allow = roles.includes('tote') || roles.includes('admin');
          } catch(_){ }
          if (!allow) {
            const sponsorId = 'tg:1417856820';
            const myId = (window.AppUser && typeof window.AppUser.resolveUserId==='function') ? window.AppUser.resolveUserId() : (localStorage.getItem('anon_uid')||'');
            if (String(myId) === sponsorId) allow = true;
          }
          if (allow) {
            const b = document.getElementById('fireReqAdminBtn');
            if (b) { b.style.display='block'; b.addEventListener('click', ()=>{ window.location.href='/fire-requests'; }); }
          }
        } catch(_){ }
      }catch(_){ }
    }
    if (document.readyState === 'loading') window.addEventListener('DOMContentLoaded', boot); else boot();
    document.addEventListener('AppShell:afterNavigate', ()=>{ try{ if (!__profileBooted) boot(); }catch(_){ } });
  })();
  </script>
  <script src="/js/footer-nav.js"></script>
  <script src="/js/music.js"></script>
</body>
</html>

