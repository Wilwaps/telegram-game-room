<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Supply • Telegram Game Room</title>
  <style>
    :root { --bg:#0b0e14; --card:#131722; --fg:#e2e8f0; --muted:#94a3b8; --accent:#22d3ee; --ok:#34d399; --warn:#fbbf24; --err:#f87171; }
    html, body { height: 100%; }
    body { margin:0; background: radial-gradient(1200px 800px at 30% -10%, rgba(34,211,238,0.1), transparent), var(--bg); color:var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; }
    .container { max-width: 960px; margin: 0 auto; padding: 24px; }
    .title { font-weight: 700; font-size: 24px; letter-spacing: .4px; }
    .subtitle { color: var(--muted); margin-top: 4px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:16px; margin-top: 20px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.06); border-radius: 14px; padding:16px; box-shadow: 0 6px 24px rgba(0,0,0,.25); backdrop-filter: blur(6px); }
    .kpi { font-size: 28px; font-weight: 700; }
    .label { color: var(--muted); font-size: 13px; }
    .logs { margin-top: 20px; background: #0e1220; border:1px solid rgba(255,255,255,0.06); border-radius: 10px; padding: 12px; max-height: 220px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,0.12); color:var(--accent); margin-left:8px; font-size:12px; }
    .btn { display:inline-flex; align-items:center; gap:8px; background: rgba(34,211,238,0.1); border:1px solid rgba(34,211,238,0.35); color:#e6fbff; padding:10px 14px; border-radius:10px; cursor:pointer; text-decoration:none; transition:.18s ease; }
    .btn:hover { transform: translateY(-1px); background: rgba(34,211,238,0.16); }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="container">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="title">Supply <span class="pill" id="pill-status">cargando…</span></div>
        <div class="subtitle">Conectada al SSE de supply</div>
      </div>
      <a class="btn" href="/api/economy/supply" target="_blank" rel="noopener">Ver JSON supply</a>
    </div>

    <div class="grid">
      <div class="card">
        <div class="label">Total supply</div>
        <div class="kpi" id="total">-</div>
      </div>
      <div class="card">
        <div class="label">Circulating</div>
        <div class="kpi" id="circ">-</div>
      </div>
      <div class="card">
        <div class="label">Burned</div>
        <div class="kpi" id="burn">-</div>
      </div>
      <div class="card">
        <div class="label">Reserva</div>
        <div class="kpi" id="reserve">-</div>
      </div>
    </div>

    <div class="logs" id="logs"></div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const fmt = (n) => new Intl.NumberFormat().format(n ?? 0);
    const log = (msg) => { const el=$('logs'); const line=document.createElement('div'); line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`; el.prepend(line); };

    async function loadSnapshot(){
      try{
        const r = await fetch('/api/economy/supply');
        const j = await r.json();
        if(j && j.success){ render(j.supply); log('Snapshot inicial cargado.'); $('pill-status').textContent='online'; }
      }catch(e){ log('Error snapshot: '+e); $('pill-status').textContent='offline'; }
    }

    function render(s){ if(!s) return; $('total').textContent=fmt(s.total); $('circ').textContent=fmt(s.circulating); $('burn').textContent=fmt(s.burned); const r=$('reserve'); if(r) r.textContent=fmt(s.reserve||0); }

    function startSSE(){
      try{
        const es = new EventSource('/api/economy/supply/stream');
        es.onmessage = (ev) => { try { const data = JSON.parse(ev.data); if(data && data.value) { render(data.value); } } catch(_){} };
        es.addEventListener('supply', (ev) => { try { const data = JSON.parse(ev.data); if(data && data.value){ render(data.value); log('SSE: supply update'); } } catch(e){ log('SSE parse error: '+e) } });
        es.onerror = () => { $('pill-status').textContent='reconectando…'; };
        es.onopen = () => { $('pill-status').textContent='online'; log('SSE conectado.'); };
      }catch(e){ log('SSE error: '+e); }
    }

    loadSnapshot();
    startSSE();
  </script>
  <script src="/js/app-user.js"></script>
  <script src="/js/music.js"></script>
</body>
</html>
