<!DOCTYPE html>
<html class="dark" lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Bingo â€¢ Telegram Game Room</title>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="/js/app-user.js"></script>
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#06e4f9',
            'background-light': '#f5f8f8',
            'background-dark': '#0B0E14',
            violet: '#a78bfa',
            accent: '#22d3ee',
            card: '#121A2B',
            panel: '#0F1524',
            text: '#E6EDF3',
            glass: 'rgba(255,255,255,0.1)',
            danger: '#EF4444',
          },
          fontFamily: { display: ['Space Grotesk'] },
          borderRadius: { DEFAULT: '0.5rem', lg: '0.75rem', xl: '1rem', full: '9999px' },
          boxShadow: {
            fire: '0 0 15px 5px rgba(255, 165, 0, 0.6), 0 0 25px 10px rgba(255, 255, 0, 0.4)',
            'neon-violet': '0 0 10px #a78bfa, 0 0 20px #a78bfa, 0 0 30px #a78bfa',
            'neon-accent': '0 0 10px #22d3ee, 0 0 20px #22d3ee, 0 0 30px #22d3ee',
            'neon-gold': '0 0 5px #facc15, 0 0 10px #facc15, 0 0 15px #facc15'
          }
        }
      }
    }
  </script>
  <style>
    body { min-height: max(884px, 100dvh); }
    .nav-item:hover { background-color: var(--tw-bg-accent); color: var(--tw-bg-background-dark); }
    .nav-item { transition: background-color 0.2s, color 0.2s; }
    .nav-item .material-symbols-outlined { display:block; margin:0 auto 0.25rem; }
    #roomView { overflow-y: auto; }
    .cards-scroll { max-height: 100%; }
    .bingo-card { background: rgba(18,26,43,0.95); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 12px; transition: box-shadow .2s, border-color .2s; }
    .bingo-card.active { border-color: #22d3ee; box-shadow: 0 0 10px rgba(34,211,238,0.4); }
    .bingo-cell { display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.08); border-radius:10px; padding:10px 0; font-size:0.9rem; background: rgba(15,21,36,0.85); cursor:pointer; transition: background .15s, border-color .15s, color .15s, box-shadow .15s; }
    .bingo-cell.called { border-color:#facc15; background: rgba(250,204,21,0.08); box-shadow: inset 0 0 8px rgba(250,204,21,0.2); }
    .bingo-cell.marked { background: rgba(34,211,238,0.2); border-color:#22d3ee; color:#22d3ee; box-shadow: 0 0 10px rgba(34,211,238,0.3); }
    .bingo-cell.free { border-style:dashed; color:#facc15; font-weight:700; }
    .claim-float { position: fixed; bottom: 112px; right: 16px; z-index: 40; display: none; }
    @supports (bottom: env(safe-area-inset-bottom)) {
      .claim-float { bottom: calc(112px + env(safe-area-inset-bottom)); }
    }
  </style>
</head>
<body class="bg-background-dark font-display text-text">
<div class="flex flex-col min-h-screen">
  <main class="flex-1 p-4 pb-24">
    <h1 class="text-3xl font-bold text-center mb-8 text-accent">Bingo</h1>

    <section class="space-y-6">
      <div class="bg-panel rounded-xl border border-glass p-4">
        <h2 class="text-xl font-bold mb-4 text-center">Salas Activas</h2>
        <div id="activeCard" class="bg-card rounded-lg p-4 flex items-center justify-between hidden">
          <p class="text-text">Sala en curso</p>
          <p id="activeInfo" class="text-yellow-400 font-bold text-lg" style="text-shadow: 0 0 8px #facc15;"></p>
        </div>
        <div class="mt-4 flex items-center gap-2">
          <input id="codeInput" class="flex-grow bg-card border border-glass rounded-lg px-3 py-2 text-text placeholder-text/50 focus:outline-none focus:ring-2 focus:ring-accent" placeholder="CÃ³digo de sala" type="text"/>
          <button id="joinCodeBtn" class="bg-accent/80 text-background-dark font-bold py-2 px-4 rounded-lg shadow-[0_0_10px_rgba(34,211,238,0.5)] hover:bg-accent transition-all duration-300">Unirme</button>
        </div>
      </div>

      <div class="bg-panel rounded-xl border border-glass p-4">
        <h2 class="text-xl font-bold mb-4 text-center">Salas Creadas</h2>
        <div id="roomsList" class="space-y-4"></div>
      </div>

      <div class="bg-panel rounded-xl border border-glass p-4">
        <h2 class="text-xl font-bold mb-4 text-center">Salas PÃºblicas</h2>
        <div id="publicRoomsList" class="space-y-4"></div>
      </div>
    </section>
  </main>

  <nav class="fixed bottom-0 left-0 right-0 bg-card border-t border-glass px-2 py-1">
    <div class="flex justify-around text-xs text-center text-text/80">
      <a class="nav-item flex-1 p-2 rounded-lg" href="/profile" style="--tw-bg-accent: #22d3ee; --tw-bg-background-dark: #0B0E14;">
        <span class="material-symbols-outlined">person</span>
        <span>Perfil</span>
      </a>
      <a class="nav-item flex-1 p-2 rounded-lg" href="/games" style="--tw-bg-accent: #22d3ee; --tw-bg-background-dark: #0B0E14;">
        <span class="material-symbols-outlined">door_open</span>
        <span>Lobby</span>
      </a>
      <a class="nav-item flex-1 p-2 rounded-lg bg-orange-500/20 shadow-fire text-orange-400" href="/games" style="--tw-bg-accent: #22d3ee; --tw-bg-background-dark: #0B0E14;">
        <span class="material-symbols-outlined">sports_esports</span>
        <span>Juegos</span>
      </a>
      <a class="nav-item flex-1 p-2 rounded-lg" href="/raffles" style="--tw-bg-accent: #22d3ee; --tw-bg-background-dark: #0B0E14;">
        <span class="material-symbols-outlined">confirmation_number</span>
        <span>Rifas</span>
      </a>
      <a class="nav-item flex-1 p-2 rounded-lg" href="#" style="--tw-bg-accent: #a78bfa; --tw-bg-background-dark: #0B0E14;">
        <span class="material-symbols-outlined" style="color: inherit">storefront</span>
        <span class="text-xs">Mercado</span>
      </a>
      <a class="nav-item flex-1 p-2 rounded-lg" href="#" style="--tw-bg-accent: #a78bfa; --tw-bg-background-dark: #0B0E14;">
        <span class="material-symbols-outlined">groups</span>
        <span>Rol</span>
      </a>
      <a class="nav-item flex-1 p-2 rounded-lg" href="#" style="--tw-bg-accent: #a78bfa; --tw-bg-background-dark: #0B0E14;">
        <span class="material-symbols-outlined">schedule</span>
        <span>PrÃ³ximo</span>
      </a>
    </div>
  </nav>
</div>

<!-- FAB crear sala -->
<button id="fabCreate" class="fixed bottom-24 right-4 bg-yellow-400 text-background-dark p-4 rounded-full shadow-[0_0_10px_#facc15,0_0_20px_#facc15] hover:bg-yellow-300 transition-all duration-300 transform hover:scale-105 z-30">
  <span class="material-symbols-outlined text-3xl">add</span>
  <span class="sr-only">Crear sala</span>
</button>

<!-- Overlay crear/configurar sala -->
<div id="createOverlay" class="hidden fixed inset-0 z-40">
  <div class="absolute inset-0 bg-background-dark/50 backdrop-blur-sm"></div>
  <div class="absolute inset-0 flex items-center justify-center p-2">
    <div class="bg-card/90 border border-glass rounded-xl w-[95vw] h-[95vh] max-w-md p-4 flex flex-col space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="font-bold text-lg">Nueva Sala de Bingo</h3>
        <button id="closeCreate" class="text-text/70 hover:text-text"><span class="material-symbols-outlined">close</span></button>
      </div>
      <div class="text-center">
        <p class="text-text/70 text-sm">CÃ³digo de la Sala</p>
        <p id="createCode" class="text-accent text-3xl font-bold tracking-widest" style="text-shadow: 0 0 10px #22d3ee;">------</p>
        <div class="flex justify-center items-center space-x-4 mt-2 text-sm">
          <span class="inline-flex items-center gap-1"><span class="material-symbols-outlined text-orange-500">local_fire_department</span><span>Pozo: <b id="createPot">0</b> ðŸ”¥</span></span>
          <span class="inline-flex items-center gap-1"><span class="material-symbols-outlined text-orange-500">local_fire_department</span><span>Mis ðŸ”¥: <b id="meFiresOverlay">0</b></span></span>
        </div>
      </div>
      <div class="space-y-2">
        <p class="text-text/70 text-sm">Visibilidad</p>
        <div class="grid grid-cols-2 gap-2">
          <button id="optPrivate" class="bg-accent text-background-dark font-bold py-2 rounded-lg shadow-[0_0_10px_#22d3ee]">Privada</button>
          <button id="optPublic" class="bg-glass text-text py-2 rounded-lg">PÃºblica</button>
        </div>
      </div>
      <div class="space-y-2">
        <p class="text-text/70 text-sm">Modo de victoria</p>
        <div class="grid grid-cols-3 gap-2 text-sm">
          <button id="modeLinea" class="bg-yellow-400/20 text-yellow-400 py-2 rounded-lg shadow-[0_0_10px_#facc15]">LÃ­nea</button>
          <button id="mode4c" class="bg-glass text-text py-2 rounded-lg">4 Esquinas</button>
          <button id="modeCarton" class="bg-glass text-text py-2 rounded-lg">CartÃ³n Lleno</button>
        </div>
      </div>
      <div class="space-y-2">
        <p class="text-text/70 text-sm">Conjunto</p>
        <div class="grid grid-cols-2 gap-2 text-sm">
          <button id="ball75" class="bg-glass text-text py-2 rounded-lg">75</button>
          <button id="ball90" class="bg-yellow-400/20 text-yellow-400 py-2 rounded-lg shadow-[0_0_10px_#facc15]">90</button>
        </div>
      </div>
      <div class="space-y-2">
        <p class="text-text/70 text-sm">Costo</p>
        <div class="grid grid-cols-2 gap-2">
          <button id="costFree" class="bg-yellow-400/20 text-yellow-400 py-2 rounded-lg flex items-center justify-center space-x-2 shadow-[0_0_10px_#facc15]">
            <span class="material-symbols-outlined text-yellow-400">monetization_on</span>
            <span>Libre</span>
          </button>
          <button id="costFuego" class="bg-glass text-text py-2 rounded-lg flex items-center justify-center space-x-2">
            <span class="material-symbols-outlined text-orange-500">local_fire_department</span>
            <span>Fuego</span>
          </button>
        </div>
      </div>
      <div class="space-y-2">
        <p class="text-text/70 text-sm">Unirme por cÃ³digo</p>
        <div class="flex space-x-2">
          <input id="joinCodeInput" class="bg-glass border-glass rounded-lg w-full text-text placeholder-text/50 px-4 py-2 focus:ring-accent focus:border-accent" placeholder="CÃ³digo de la sala" type="text"/>
          <button id="joinFromCreate" class="bg-accent text-background-dark font-bold py-2 px-4 rounded-lg shadow-[0_0_10px_#22d3ee]">Unirme</button>
        </div>
      </div>
      <div class="mt-auto space-y-2">
        <button id="shareCreate" class="w-full bg-violet text-text font-bold py-3 rounded-lg shadow-[0_0_10px_#a78bfa]">Compartir</button>
        <button id="startCreate" class="w-full bg-gradient-to-r from-orange-500 to-yellow-400 text-text font-bold py-3 rounded-lg shadow-[0_0_15px_rgba(255,165,0,0.6)]">Abrir Sala</button>
      </div>
    </div>
  </div>
  
</div>

<!-- Vista de sala -->
<section id="roomView" class="hidden fixed inset-0 z-30 bg-background-dark/98 backdrop-blur-sm">
  <div class="relative h-full">
    <div class="p-4 pb-40 h-full overflow-y-auto max-w-5xl mx-auto space-y-4">
      <div class="flex flex-wrap items-center justify-between gap-2">
        <div class="text-sm">Tu ID: <span id="me" class="font-mono"></span></div>
        <div class="text-sm flex items-center gap-3">
          <span class="inline-flex items-center gap-1"><span class="material-symbols-outlined text-orange-500">local_fire_department</span><b id="meFires">0</b></span>
          <span class="inline-flex items-center gap-1"><span class="material-symbols-outlined text-yellow-400">monetization_on</span><b id="meCoins">0</b></span>
          <span>Sala: <span id="roomCode" class="text-accent font-mono"></span></span>
        </div>
      </div>
      <div class="bg-card border border-glass rounded-lg p-3 flex flex-wrap gap-4 items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="inline-flex items-center gap-1 text-sm"><span class="material-symbols-outlined text-orange-500">local_fire_department</span> Pozo: <b id="potVal">0</b> ðŸ”¥</span>
          <span class="inline-flex items-center gap-1 text-sm">Modo: <b id="modeVal">-</b></span>
        </div>
        <div class="flex items-center gap-2 text-sm">
          <span>Ãšltimo:</span>
          <span id="lastCall" class="text-yellow-400 font-bold text-lg"></span>
          <button id="drawBtn" class="hidden bg-accent text-background-dark font-bold py-1 px-3 rounded-lg">Extraer</button>
        </div>
        <div class="flex items-center gap-2">
          <button id="tablaToggle" class="bg-glass text-text px-3 py-1 rounded-lg">Tabla</button>
        </div>
      </div>
    </div>
    <div class="bg-panel border border-glass rounded-lg p-3">
      <h3 class="font-bold mb-2">NÃºmeros llamados</h3>
      <div id="calledList" class="text-sm flex flex-wrap gap-2"></div>
    </div>
    <div id="tablaPanel" class="hidden bg-panel border border-glass rounded-lg p-3">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-bold">Tabla</h3>
        <span id="tablaInfo" class="text-sm text-text/70"></span>
      </div>
      <div id="tablaGrid" class="grid gap-1"></div>
    </div>
    <div id="lobbyPanel" class="bg-panel border border-glass rounded-lg p-3">
      <h3 class="font-bold mb-2">Lobby</h3>
      <div class="flex items-center gap-2">
        <label class="text-sm">Mis cartones:</label>
        <select id="cardsCount" class="bg-card border border-glass rounded px-2 py-1 text-sm">
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
        </select>
        <label class="inline-flex items-center gap-1 text-sm"><input id="readyChk" type="checkbox" class="rounded border-glass"/> Listo</label>
        <button id="startBtn" class="hidden bg-yellow-400 text-background-dark font-bold py-1 px-3 rounded-lg">Iniciar</button>
      </div>
      <div id="playersList" class="mt-3 text-sm text-text/80"></div>
    </div>
      <div class="cards-scroll overflow-y-auto pr-1">
        <div id="cardsWrap" class="grid md:grid-cols-2 gap-4"></div>
      </div>
      <div class="flex gap-2">
        <a href="/games" class="flex-1 bg-transparent text-text py-2 rounded-lg font-bold border border-text/50 text-center">Salir</a>
      </div>
      <div id="gameOver" class="hidden text-center space-y-2">
        <p class="text-3xl font-bold">Â¡BINGO!</p>
        <p>Ganador: <b id="winnerVal">-</b></p>
        <div class="flex gap-2 max-w-sm mx-auto">
          <button id="rematchBtn" class="flex-1 bg-yellow-400 text-background-dark font-bold py-2 rounded-lg hidden">Revancha</button>
          <a href="/games" class="flex-1 bg-transparent text-text py-2 rounded-lg font-bold border border-text/50 text-center">Ir al Lobby</a>
        </div>
      </div>
    </div>
    <button id="claimBtn" class="claim-float bg-violet text-text font-bold py-3 px-6 rounded-full shadow-[0_0_18px_rgba(167,139,250,0.65)]">Cantar</button>
  </div>
</section>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  function getQuery(name){
    try { return new URL(window.location.href).searchParams.get(name); } catch(_) { return null }
  }
  const fabCreate = $('fabCreate');
  const overlay = $('createOverlay');
  const closeCreate = $('closeCreate');
  const createCode = $('createCode');
  const createPot = $('createPot');
  const optPrivate = $('optPrivate');
  const optPublic = $('optPublic');
  const modeLinea = $('modeLinea');
  const mode4c = $('mode4c');
  const modeCarton = $('modeCarton');
  const ball75 = $('ball75');
  const ball90 = $('ball90');
  const costFree = $('costFree');
  const costFuego = $('costFuego');
  const joinCodeInput = $('joinCodeInput');
  const joinFromCreate = $('joinFromCreate');
  const shareCreate = $('shareCreate');
  const startCreate = $('startCreate');
  const roomView = $('roomView');
  const meEl = $('me');
  const roomCodeEl = $('roomCode');
  const potVal = $('potVal');
  const modeVal = $('modeVal');
  const lastCall = $('lastCall');
  const calledList = $('calledList');
  const drawBtn = $('drawBtn');
  const tablaToggle = $('tablaToggle');
  const tablaPanel = $('tablaPanel');
  const tablaGrid = $('tablaGrid');
  const tablaInfo = $('tablaInfo');
  const startBtn = $('startBtn');
  const cardsCountSel = $('cardsCount');
  const readyChk = $('readyChk');
  const lobbyPanel = $('lobbyPanel');
  const playersList = $('playersList');
  const cardsWrap = $('cardsWrap');
  const claimBtn = $('claimBtn');
  const gameOver = $('gameOver');
  const winnerVal = $('winnerVal');
  const roomsList = $('roomsList');
  const publicRoomsList = $('publicRoomsList');
  const codeInput = $('codeInput');
  const joinCodeBtn = $('joinCodeBtn');
  const activeCard = $('activeCard');
  const activeInfo = $('activeInfo');

  let myId = null;
  let roomId = null;
  let es = null;
  let currentBallSet = 90;
  let tablaOpen = false;
  let stateCalled = [];
  let stateLast = null;
  const userMarks = new Map();
  let createdRoomId = null;
  let createVisibility = 'private';
  let createCostType = 'free';
  let createCostValue = 1; // 1 ðŸ”¥ por cartÃ³n
  let createMode = 'linea';
  let createBallSet = 90;
  let selectedCardIdx = 0;
  let lobbyES = null;
  let lobbyRoomId = null;

  function getUserId(){
    try { if (window.AppUser && typeof AppUser.resolveUserId==='function') return AppUser.resolveUserId(); } catch(_){ }
    const tg = window.Telegram && window.Telegram.WebApp;
    const user = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;
    if (user && user.id) return 'tg:' + String(user.id);
    let anon = sessionStorage.getItem('anonId');
    if (!anon) { anon = 'anon:' + Math.random().toString(36).slice(2,10); sessionStorage.setItem('anonId', anon); }
    return anon;
  }
  function styleToggle(btnOn, btnOff, onClasses, offClasses){
    btnOn.className = (btnOn.className.replace(' bg-glass','').replace(' text-text','') + onClasses);
    btnOff.className = (btnOff.className.replace(' bg-accent text-background-dark','').replace(' shadow-[0_0_10px_#22d3ee]','').replace(' bg-yellow-400/20 text-yellow-400 shadow-[0_0_10px_#facc15]','') + offClasses);
  }
  function openCreate(){ overlay.classList.remove('hidden'); createdRoomId = null; createCode.textContent='------'; createPot.textContent='0'; }
  function closeCreateOverlay(){ overlay.classList.add('hidden'); }

  async function api(path, opts){
    const r = await fetch(path, opts);
    let j=null; try { j = await r.json(); } catch(_){ }
    if (!r.ok || !j || j.success===false){
      const msg = (j && (j.error||j.message)) || ('http_'+r.status);
      throw new Error(msg);
    }
    return j;
  }
  function notify(msg){
    try{
      const el = document.createElement('div');
      el.className = 'fixed bottom-24 left-1/2 -translate-x-1/2 bg-red-500 text-white px-3 py-2 rounded shadow z-50 text-sm';
      el.textContent = String(msg||'Error');
      document.body.appendChild(el);
      setTimeout(()=>{ try{ el.remove(); }catch(_){ } }, 2000);
    }catch(_){ alert(String(msg||'Error')); }
  }

  async function syncOptions(){
    if (!createdRoomId) return;
    const payload = { userId: myId, visibility: createVisibility, mode: createMode, ballSet: String(createBallSet) };
    if (createCostType === 'fuego') { payload.costType = 'fuego'; payload.costValue = 1; } else { payload.costType = 'free'; payload.costValue = 0; }
    try { await api(`/api/games/bingo/rooms/${encodeURIComponent(createdRoomId)}/options`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); } catch(_) {}
  }

  async function loadLobby(){
    // Mis salas
    roomsList.innerHTML='';
    try{
      const j = await api(`/api/games/bingo/my-rooms?userId=${encodeURIComponent(myId)}`);
      const arr = (j && j.success && Array.isArray(j.rooms)) ? j.rooms : [];
      if (!arr.length) {
        const empty=document.createElement('div'); empty.className='text-center text-text/60'; empty.textContent='No has creado salas'; roomsList.appendChild(empty);
      } else {
        for (const rm of arr){
          const wrap = document.createElement('div');
          wrap.className='bg-card rounded-lg p-4 border border-glass flex items-center justify-between';
          wrap.innerHTML = `<span class="text-accent font-mono">#${rm.code||'------'}</span>
            <a class="underline text-accent" href="#" data-room="${rm.id}">Abrir</a>`;
          wrap.querySelector('a')?.addEventListener('click', async (e)=>{ e.preventDefault(); await joinRoom(rm.id); });
          roomsList.appendChild(wrap);
        }
      }
      // Banner de sala activa
      const playing = arr.find(rm => rm.status==='playing');
      if (playing) updateActiveRoomBanner(playing); else updateActiveRoomBanner(null);
    }catch(_){ }
    // Salas pÃºblicas
    publicRoomsList.innerHTML='';
    try{
      const jp = await api('/api/games/bingo/public-rooms');
      const parr = (jp && jp.success && Array.isArray(jp.rooms)) ? jp.rooms : [];
      if (!parr.length) { const empty=document.createElement('div'); empty.className='text-center text-text/60'; empty.textContent='Sin salas pÃºblicas'; publicRoomsList.appendChild(empty); }
      else {
        for (const rm of parr){
          const wrap = document.createElement('div');
          wrap.className='bg-card rounded-lg p-4 border border-glass flex items-center justify-between';
          wrap.innerHTML = `<span class="text-accent font-mono">#${rm.code||'------'}</span>
            <a class="underline text-accent" href="#" data-room="${rm.id}">Abrir</a>`;
          wrap.querySelector('a')?.addEventListener('click', async (e)=>{ e.preventDefault(); await joinRoom(rm.id); });
          publicRoomsList.appendChild(wrap);
        }
      }
    }catch(_){ }
  }

  async function createRoom(){
    const payload = { userId: myId, visibility: createVisibility, costType: createCostType, costValue: createCostValue, mode: createMode };
    payload.ballSet = String(createBallSet);
    const j = await api('/api/games/bingo/rooms', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if (!j || !j.success) throw new Error('create_failed');
    createdRoomId = j.state.id; createCode.textContent = j.state.code || '------'; createPot.textContent = String(j.state.potFires||0);
    await joinRoom(createdRoomId);
    await syncOptions();
  }
  async function joinRoom(id){
    const j = await api(`/api/games/bingo/rooms/${encodeURIComponent(id)}/join`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: myId }) });
    if (!j || !j.success) throw new Error(j && j.error || 'join_failed');
    roomId = j.state.id; roomCodeEl.textContent = j.state.code || '------';
    subscribe();
    roomView.classList.remove('hidden');
  }

  function renderCalled(arr){
    calledList.innerHTML='';
    const a = Array.isArray(arr)?arr:[];
    const last = a.length ? a[a.length-1] : null;
    const slice = a.slice(-10);
    for (let i=0;i<slice.length;i++){
      const n = slice[i];
      const isLast = (n===last);
      const b = document.createElement('span');
      b.className = 'px-2 py-1 rounded border ' + (isLast ? 'bg-yellow-400/30 border-yellow-400 text-yellow-300' : 'bg-card border-glass');
      b.textContent = String(n);
      calledList.appendChild(b);
    }
  }

  function renderTabla(ballSet, calledArr, last){
    const max = [75,90].includes(Number(ballSet)) ? Number(ballSet) : 90;
    const cols = (max===75) ? 15 : 10;
    tablaGrid.style.gridTemplateColumns = `repeat(${cols}, minmax(0,1fr))`;
    tablaGrid.innerHTML = '';
    const set = new Set(calledArr||[]);
    for (let i=1;i<=max;i++){
      const el = document.createElement('div');
      const called = set.has(i);
      const isLast = (i===last);
      el.className = 'px-2 py-1 text-center rounded border ' + (called ? (isLast ? 'bg-yellow-400/40 border-yellow-400 text-yellow-300' : 'bg-card border-yellow-500 text-yellow-300') : 'bg-card border-glass text-text/80');
      el.textContent = String(i);
      tablaGrid.appendChild(el);
    }
    tablaInfo.textContent = `Conjunto: ${max} â€¢ Cantados: ${(calledArr||[]).length}`;
  }
  function renderPlayers(players){
    playersList.innerHTML='';
    for (const p of players||[]){
      const div = document.createElement('div');
      div.textContent = `${p.userId} â€¢ ${p.ready ? 'Listo' : 'No listo'} â€¢ cartones: ${p.cardsCount||1}`;
      playersList.appendChild(div);
    }
  }
  function renderCards(myCards, called){
    cardsWrap.innerHTML='';
    if (!Array.isArray(myCards) || !myCards.length) return;
    const cset = new Set(called||[]);
    myCards.forEach((card, idx)=>{
      const box = document.createElement('div'); box.className='bg-card border border-glass rounded-lg p-3'; box.dataset.idx=String(idx);
      const title = document.createElement('div'); title.className='text-sm mb-2 flex items-center justify-between'; title.innerHTML = `<b>CartÃ³n ${idx+1}</b>`; box.appendChild(title);
      const grid = document.createElement('div'); grid.className='grid grid-cols-5 gap-1';
      for (let r=0;r<5;r++){
        for (let c=0;c<5;c++){
          const v = card[r][c];
          const cell = document.createElement('div');
          const isFree = (r===2 && c===2 && v==='FREE');
          const calledOk = isFree || cset.has(v);
          const marks = userMarks.get(idx) || new Set();
          const key = r+','+c;
          const isMarked = marks.has(key);
          cell.className='bingo-cell ' + (calledOk ? 'called ' : '') + (isMarked ? 'marked ' : '');
          cell.textContent = isFree ? 'â˜…' : String(v);
          cell.addEventListener('click', ()=>{
            if (!(isFree || cset.has(v))) return;
            let set = userMarks.get(idx); if (!set){ set = new Set(); userMarks.set(idx, set); }
            if (set.has(key)) set.delete(key); else set.add(key);
            cell.classList.toggle('marked');
          });
          grid.appendChild(cell);
        }
      }
      box.appendChild(grid);
      box.addEventListener('click', ()=>{
        selectedCardIdx = idx;
        const boxes = cardsWrap.querySelectorAll('[data-idx]');
        boxes.forEach(el=>{ el.className = el.className.replace(' ring-2 ring-accent',''); });
        box.className += ' ring-2 ring-accent';
      });
      if (idx === selectedCardIdx) { box.className += ' ring-2 ring-accent'; }
      cardsWrap.appendChild(box);
    });
  }

  function subscribe(){
    if (!roomId) return; try{ es && es.close && es.close(); }catch(_){ }
    es = new EventSource(`/api/games/bingo/rooms/${encodeURIComponent(roomId)}/stream`);
    es.addEventListener('state', (ev)=>{
      try{
        const s = JSON.parse(ev.data);
        potVal.textContent = String(s.potFires||0);
        modeVal.textContent = (s.mode==='4c' ? '4 Esquinas' : (s.mode==='carton' ? 'CartÃ³n Lleno' : 'LÃ­nea'));
        lastCall.textContent = String(s.lastCall||'');
        currentBallSet = Number(s.ballSet||90);
        stateCalled = Array.isArray(s.called) ? s.called.slice() : [];
        stateLast = (typeof s.lastCall!=='undefined' && s.lastCall!==null) ? Number(s.lastCall) : null;
        renderCalled(stateCalled);
        renderPlayers(s.players||[]);
        if (tablaOpen) { renderTabla(currentBallSet, s.called||[], s.lastCall||null); }
        // host controls
        const isHost = (s.hostId === myId);
        drawBtn.classList.toggle('hidden', !(isHost && s.status==='playing'));
        startBtn.classList.toggle('hidden', !(isHost && s.status==='lobby'));
        lobbyPanel.style.display = (s.status==='lobby') ? 'block' : 'none';
        // ocultar Cantar si no estÃ¡ en juego
        claimBtn.style.display = (s.status==='playing') ? 'block' : 'none';
        // my cards
        const me = (s.players||[]).find(p=> p.userId===myId);
        const myCards = me && me.cards ? me.cards : [];
        renderCards(myCards, s.called||[]);
        // game over
        if (s.status==='finished'){
          gameOver.classList.remove('hidden');
          const w = (s.winners && s.winners[0] && s.winners[0].userId) || '-';
          winnerVal.textContent = w;
          // botÃ³n Revancha solo para host
          const isHost2 = (s.hostId === myId);
          const rematchBtn = document.getElementById('rematchBtn');
          if (rematchBtn) rematchBtn.classList.toggle('hidden', !isHost2);
        } else { gameOver.classList.add('hidden'); }
      }catch(_){ }
    });
  }

  function updateActiveRoomBanner(room){
    if (room && (room.status==='playing')){
      activeCard.classList.remove('hidden');
      const txt = room.lastCall ? `Ãšltimo: ${room.lastCall}` : 'Jugando';
      activeInfo.textContent = txt;
      // Suscribirse por SSE a la sala para mantener banner en vivo
      if (lobbyRoomId !== room.id){
        try { lobbyES && lobbyES.close && lobbyES.close(); } catch(_){ }
        lobbyRoomId = room.id;
        lobbyES = new EventSource(`/api/games/bingo/rooms/${encodeURIComponent(lobbyRoomId)}/stream`);
        lobbyES.addEventListener('state', (ev)=>{
          try { const s = JSON.parse(ev.data); updateActiveRoomBanner(s); } catch(_){ }
        });
      }
    } else {
      activeCard.classList.add('hidden');
      try { lobbyES && lobbyES.close && lobbyES.close(); } catch(_){ }
      lobbyES = null; lobbyRoomId = null;
    }
  }

  // Handlers
  fabCreate.addEventListener('click', openCreate);
  closeCreate.addEventListener('click', closeCreateOverlay);
  optPrivate.addEventListener('click', ()=>{ createVisibility='private'; styleToggle(optPrivate,optPublic,' bg-accent text-background-dark shadow-[0_0_10px_#22d3ee]',' bg-glass text-text'); syncOptions(); });
  optPublic.addEventListener('click', ()=>{ createVisibility='public'; styleToggle(optPublic,optPrivate,' bg-accent text-background-dark shadow-[0_0_10px_#22d3ee]',' bg-glass text-text'); syncOptions(); });
  modeLinea.addEventListener('click', ()=>{ createMode='linea'; styleToggle(modeLinea,mode4c,' bg-yellow-400/20 text-yellow-400 shadow-[0_0_10px_#facc15]',' bg-glass text-text'); styleToggle(modeLinea,modeCarton,' bg-yellow-400/20 text-yellow-400 shadow-[0_0_10px_#facc15]',' bg-glass text-text'); syncOptions(); });
  mode4c.addEventListener('click', ()=>{ createMode='4c'; styleToggle(mode4c,modeLinea,' bg-yellow-400/20 text-yellow-400 shadow-[0_0_10px_#facc15]',' bg-glass text-text'); styleToggle(mode4c,modeCarton,' bg-yellow-400/20 text-yellow-400 shadow-[0_0_10px_#facc15]',' bg-glass text-text'); syncOptions(); });
  modeCarton.addEventListener('click', ()=>{ createMode='carton'; styleToggle(modeCarton,modeLinea,' bg-yellow-400/20 text-yellow-400 shadow-[0_0_10px_#facc15]',' bg-glass text-text'); styleToggle(modeCarton,mode4c,' bg-yellow-400/20 text-yellow-400 shadow-[0_0_10px_#facc15]',' bg-glass text-text'); syncOptions(); });
  ball75.addEventListener('click', ()=>{ createBallSet=75; styleToggle(ball75,ball90,' bg-yellow-400/20 text-yellow-400 shadow-[0_0_10px_#facc15]',' bg-glass text-text'); syncOptions(); });
  ball90.addEventListener('click', ()=>{ createBallSet=90; styleToggle(ball90,ball75,' bg-yellow-400/20 text-yellow-400 shadow-[0_0_10px_#facc15]',' bg-glass text-text'); syncOptions(); });
  costFree.addEventListener('click', ()=>{ createCostType='free'; styleToggle(costFree,costFuego,' bg-yellow-400/20 text-yellow-400 shadow-[0_0_10px_#facc15]',' bg-glass text-text'); syncOptions(); });
  costFuego.addEventListener('click', ()=>{ createCostType='fuego'; styleToggle(costFuego,costFree,' bg-yellow-400/20 text-yellow-400 shadow-[0_0_10px_#facc15]',' bg-glass text-text'); syncOptions(); });
  shareCreate.addEventListener('click', async ()=>{
    if (!createdRoomId) return; const link = `${location.origin}/games/bingo?room=${encodeURIComponent(createdRoomId)}`; try{ await navigator.clipboard.writeText(link); shareCreate.textContent='Copiado'; setTimeout(()=>shareCreate.textContent='Compartir', 1200);}catch(_){ }
  });
  startCreate.addEventListener('click', async ()=>{ if (!createdRoomId) { await createRoom().catch(e=>notify(e.message)); } if (createdRoomId) { closeCreateOverlay(); } });
  joinFromCreate.addEventListener('click', async ()=>{
    const code = (joinCodeInput.value||'').trim(); if (!code) return;
    try{ const j = await api('/api/games/bingo/join-code', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code, userId: myId }) }); if (j && j.success && j.state && j.state.id) { roomId = j.state.id; roomCodeEl.textContent=j.state.code||'------'; subscribe(); roomView.classList.remove('hidden'); closeCreateOverlay(); } }catch(e){ notify(e.message); }
  });
  joinCodeBtn.addEventListener('click', async ()=>{
    const code = (codeInput.value||'').trim(); if (!code) return;
    try{ const j = await api('/api/games/bingo/join-code', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code, userId: myId }) }); if (j && j.success && j.state && j.state.id) { roomId = j.state.id; roomCodeEl.textContent=j.state.code||'------'; subscribe(); roomView.classList.remove('hidden'); } }catch(e){ notify(e.message); }
  });
  startBtn.addEventListener('click', async ()=>{ if (!roomId) return; try{ const j = await api(`/api/games/bingo/rooms/${encodeURIComponent(roomId)}/start`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: myId }) }); if (j && j.success) { } }catch(e){ notify(e.message); } });
  drawBtn.addEventListener('click', async ()=>{ if (!roomId) return; try{ await api(`/api/games/bingo/rooms/${encodeURIComponent(roomId)}/draw`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: myId }) }); }catch(e){ notify(e.message); } });
  tablaToggle.addEventListener('click', ()=>{
    tablaOpen = !tablaOpen;
    if (tablaOpen) {
      tablaPanel.classList.remove('hidden');
      renderTabla(currentBallSet, stateCalled, stateLast);
    } else {
      tablaPanel.classList.add('hidden');
    }
  });
  cardsCountSel.addEventListener('change', async ()=>{ if (!roomId) return; const n = Number(cardsCountSel.value||'1')||1; try{ await api(`/api/games/bingo/rooms/${encodeURIComponent(roomId)}/ready`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: myId, cardsCount: n }) }); }catch(e){ notify(e.message); } });
  readyChk.addEventListener('change', async ()=>{ if (!roomId) return; const r = !!readyChk.checked; try{ await api(`/api/games/bingo/rooms/${encodeURIComponent(roomId)}/ready`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: myId, ready: r, cardsCount: Number(cardsCountSel.value||'1') }) }); }catch(e){ notify(e.message); } });
  claimBtn.addEventListener('click', async ()=>{ if (!roomId) return; try{ const j = await api(`/api/games/bingo/rooms/${encodeURIComponent(roomId)}/claim`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: myId, cardIndex: selectedCardIdx }) }); if (!(j && j.success)) { } }catch(e){ notify(e.message); } });
  document.getElementById('rematchBtn')?.addEventListener('click', async ()=>{
    if (!roomId) return; try{ const j = await api(`/api/games/bingo/rooms/${encodeURIComponent(roomId)}/rematch`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: myId }) }); if (j && j.success) { } }catch(e){ notify(e.message); }
  });

  // init
  (async function init(){
    myId = getUserId(); meEl.textContent = myId;
    // perfil
    try{
      const r = await fetch(`/api/profile/${encodeURIComponent(myId)}`);
      const j = await r.json();
      if (j && j.success && j.user){
        const fires = Number(j.user.fires||0); const coins = Number(j.user.coins||0);
        const fEl = document.getElementById('meFires'); if (fEl) fEl.textContent = String(fires);
        const cEl = document.getElementById('meCoins'); if (cEl) cEl.textContent = String(coins);
        const fOv = document.getElementById('meFiresOverlay'); if (fOv) fOv.textContent = String(fires);
      }
    }catch(_){ }
    const rid = getQuery('room');
    if (rid) { try{ await joinRoom(rid); } catch(_){ await loadLobby(); } }
    else { await loadLobby(); }
  })();
})();
</script>
</body>
</html>
