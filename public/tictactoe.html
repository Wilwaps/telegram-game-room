<!DOCTYPE html>
<html class="dark" lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>La Vieja • Telegram Game Room</title>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#06e4f9',
            'background-dark': '#0B0E14',
            accent: '#22d3ee',
            card: '#121A2B',
            panel: '#0F1524',
            text: '#E6EDF3',
            glass: 'rgba(255,255,255,0.1)',
            danger: '#EF4444'
          },
          fontFamily: { display: ['Space Grotesk'] },
          boxShadow: {
            gold: '0 0 12px 4px rgba(255, 215, 0, 0.6), 0 0 24px 8px rgba(255, 215, 0, 0.35)',
            'neon-violet': '0 0 10px #a78bfa, 0 0 20px #a78bfa, 0 0 30px #a78bfa',
            'neon-accent': '0 0 10px #22d3ee, 0 0 20px #22d3ee, 0 0 30px #22d3ee',
            'neon-red': '0 0 10px rgba(239, 68, 68, 0.6), 0 0 20px rgba(239, 68, 68, 0.4)',
            'neon-gold': '0 0 5px #facc15, 0 0 10px #facc15, 0 0 15px #facc15, 0 0 20px #facc15',
            'neon-cyan-faint': '0 0 8px #21d5ed'
          },
          borderRadius: { DEFAULT: '0.5rem' }
        }
      }
    }
  </script>
  <style>
    body { min-height: max(884px, 100dvh); }
    .cell:hover { box-shadow: 0 0 12px 4px rgba(255, 215, 0, 0.6), 0 0 24px 8px rgba(255, 215, 0, 0.35); border-color: #facc15; }
    .cell.selected { box-shadow: 0 0 8px 3px rgba(255, 215, 0, 0.5) inset; }
    .neon-text-accent { text-shadow: 0 0 5px #22d3ee, 0 0 10px #22d3ee, 0 0 15px #22d3ee; }
    .neon-text-violet { text-shadow: 0 0 5px #a78bfa, 0 0 10px #a78bfa, 0 0 15px #a78bfa; }
    .neon-text-gold { text-shadow: 0 0 5px #facc15, 0 0 10px #facc15, 0 0 15px #facc15; }
  </style>
</head>
<body class="bg-background-dark font-display text-text">
<div class="flex flex-col min-h-screen">
  <main class="flex-1 p-4 pb-24">
    <div class="max-w-md mx-auto space-y-4">
      <h1 class="text-3xl font-bold text-center text-accent">La Vieja</h1>

      <!-- Lobby -->
      <section id="lobby" class="space-y-6">
        <div class="bg-panel rounded-xl border border-glass p-4">
          <h2 class="text-xl font-bold mb-4 text-center">Salas Activas</h2>
          <div id="activeCard" class="bg-card rounded-lg p-4 flex items-center justify-between shadow-neon-red hidden">
            <p class="text-text">Regresa a tu sala</p>
            <p class="text-danger font-bold text-lg" id="countdown" style="text-shadow: 0 0 8px #EF4444;">00:30 seg</p>
          </div>
          <div class="mt-4 flex items-center gap-2">
            <input id="codeInput" class="flex-grow bg-card border border-glass rounded-lg px-3 py-2 text-text placeholder-text/50 focus:outline-none focus:ring-2 focus:ring-accent" placeholder="Código de sala" type="text"/>
            <button id="joinCodeBtn" class="bg-accent/80 text-background-dark font-bold py-2 px-4 rounded-lg shadow-[0_0_10px_rgba(34,211,238,0.5)] hover:bg-accent transition-all duration-300">Unirme</button>
          </div>
        </div>

        <div class="bg-panel rounded-xl border border-glass p-4">
          <h2 class="text-xl font-bold mb-4 text-center">Salas Creadas</h2>
          <div id="roomsList" class="space-y-4"></div>
        </div>
        <div class="bg-panel rounded-xl border border-glass p-4">
          <h2 class="text-xl font-bold mb-4 text-center">Salas Públicas</h2>
          <div id="publicRoomsList" class="space-y-4"></div>
        </div>
      </section>

      <!-- Room/Board View -->
      <section id="roomView" class="space-y-4 hidden">
        <div class="w-full flex flex-col items-center space-y-2">
          <div class="flex items-center justify-center space-x-4 text-2xl font-bold">
            <span id="scoreXVal" class="text-accent">0</span>
            <span class="material-symbols-outlined text-3xl text-text">swords</span>
            <span id="scoreOVal" class="text-violet">0</span>
          </div>
          <div class="text-center">
            <p id="timerVal" class="text-3xl font-bold text-yellow-400">00:30</p>
          </div>
        </div>
        <div class="bg-card border border-glass rounded-lg p-4 space-y-2">
          <div class="flex items-center justify-between text-sm">
            <div>Tu ID: <span id="me" class="font-mono"></span></div>
            <div>Tu marca: <span id="myMark" class="font-bold"></span></div>
          </div>
          <div class="flex items-center justify-between text-sm">
            <div>Room: <a id="roomLink" class="underline text-accent" href="#" target="_blank"></a></div>
            <div>Turno: <span id="turn" class="font-bold"></span></div>
          </div>
          <div class="text-center text-sm">Estado: <span id="status" class="font-semibold"></span></div>
        </div>
        <div id="grid" class="grid grid-cols-3 gap-2 select-none"></div>

        <div class="flex gap-2">
          <button id="newBtn" class="flex-1 bg-accent text-background-dark font-bold py-2 rounded-lg">Crear sala</button>
          <button id="copyBtn" class="flex-1 bg-primary text-background-dark font-bold py-2 rounded-lg">Copiar enlace</button>
        </div>

        <div class="text-xs text-text/70">
          - Haz click en una casilla vacía cuando sea tu turno. La jugada válida brillará en dorado.
        </div>

        <div class="w-full max-w-sm mx-auto flex gap-2" id="afterRound" style="display:none">
          <button id="rematchBtn" class="flex-1 bg-yellow-400 text-background-dark py-2 rounded-lg font-bold">Revancha</button>
          <a href="/games" class="flex-1 bg-transparent text-text py-2 rounded-lg font-bold border border-text/50 text-center">Salir</a>
        </div>
      </section>
    </div>
  </main>

  <nav class="fixed bottom-0 left-0 right-0 bg-card border-t border-glass px-2 py-1">
    <div class="flex justify-around text-xs text-center text-text/80">
      <a class="nav-item flex-1 p-2 rounded-lg" href="/profile" style="--tw-bg-accent: #22d3ee; --tw-bg-background-dark: #0B0E14;">
        <span class="material-symbols-outlined">person</span>
        <span>Perfil</span>
      </a>
      <a class="nav-item flex-1 p-2 rounded-lg" href="/games" style="--tw-bg-accent: #22d3ee; --tw-bg-background-dark: #0B0E14;">
        <span class="material-symbols-outlined">door_open</span>
        <span>Lobby</span>
      </a>
      <a class="nav-item flex-1 p-2 rounded-lg bg-orange-500/20 shadow-fire text-orange-400" href="/games" style="--tw-bg-accent: #22d3ee; --tw-bg-background-dark: #0B0E14;">
        <span class="material-symbols-outlined">sports_esports</span>
        <span>Juegos</span>
      </a>
      <a class="nav-item flex-1 p-2 rounded-lg" href="/raffles" style="--tw-bg-accent: #22d3ee; --tw-bg-background-dark: #0B0E14;">
        <span class="material-symbols-outlined">confirmation_number</span>
        <span>Rifas</span>
      </a>
      <a class="nav-item flex-1 p-2 rounded-lg" href="#" style="--tw-bg-accent: #a78bfa; --tw-bg-background-dark: #0B0E14;">
        <span class="material-symbols-outlined" style="color: inherit">storefront</span>
        <span class="text-xs">Mercado</span>
      </a>
      <a class="nav-item flex-1 p-2 rounded-lg" href="#" style="--tw-bg-accent: #a78bfa; --tw-bg-background-dark: #0B0E14;">
        <span class="material-symbols-outlined">groups</span>
        <span>Rol</span>
      </a>
      <a class="nav-item flex-1 p-2 rounded-lg" href="#" style="--tw-bg-accent: #a78bfa; --tw-bg-background-dark: #0B0E14;">
        <span class="material-symbols-outlined">schedule</span>
        <span>Próximo</span>
      </a>
    </div>
  </nav>
</div>

<!-- FAB crear sala -->
<button id="fabCreate" class="fixed bottom-24 right-4 bg-yellow-400 text-background-dark p-4 rounded-full shadow-[0_0_10px_#facc15,0_0_20px_#facc15] hover:bg-yellow-300 transition-all duration-300 transform hover:scale-105 z-30">
  <span class="material-symbols-outlined text-3xl">add</span>
  <span class="sr-only">Crear sala</span>
</button>

<!-- Overlay creación de sala -->
<div id="createOverlay" class="hidden fixed inset-0 z-40">
  <div class="absolute inset-0 bg-background-dark/50 backdrop-blur-sm"></div>
  <div class="absolute inset-0 flex items-center justify-center p-2">
    <div class="bg-card/90 border border-glass rounded-xl w-[95vw] h-[95vh] max-w-md p-4 flex flex-col space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="font-bold text-lg">Nueva Sala</h3>
        <button id="closeCreate" class="text-text/70 hover:text-text"><span class="material-symbols-outlined">close</span></button>
      </div>
      <div class="text-center">
        <p class="text-text/70 text-sm">Código de la Sala</p>
        <p id="createCode" class="text-accent text-3xl font-bold tracking-widest" style="text-shadow: 0 0 10px #22d3ee;">------</p>
        <div class="text-xs text-text/70 mt-1">V: <span id="scoreX">0</span> / E: <span id="scoreD">0</span> / D: <span id="scoreO">0</span></div>
        <div class="flex justify-center items-center space-x-4 mt-2">
          <div class="flex items-center space-x-1">
            <span class="material-symbols-outlined text-yellow-400 text-base">monetization_on</span>
            <span class="text-sm" id="costCoins">0</span>
          </div>
          <div class="flex items-center space-x-1">
            <span class="material-symbols-outlined text-orange-500 text-base">local_fire_department</span>
            <span class="text-sm" id="costFuego">0</span>
          </div>
        </div>
      </div>

      <div class="space-y-2">
        <p class="text-text/70 text-sm">Modo de juego</p>
        <div class="grid grid-cols-2 gap-2">
          <button id="optPrivate" class="bg-accent text-background-dark font-bold py-2 rounded-lg shadow-[0_0_10px_#22d3ee]">Privada</button>
          <button id="optPublic" class="bg-glass text-text py-2 rounded-lg">Pública</button>
        </div>
      </div>

      <div class="space-y-2">
        <p class="text-text/70 text-sm">Costo de la partida</p>
        <div class="grid grid-cols-2 gap-2">
          <button id="optFree" class="bg-yellow-400/20 text-yellow-400 py-2 rounded-lg flex items-center justify-center space-x-2 shadow-[0_0_10px_#facc15]">
            <span class="material-symbols-outlined text-yellow-400">monetization_on</span>
            <span>Libre</span>
          </button>
          <button id="optFuego" class="bg-glass text-text py-2 rounded-lg flex items-center justify-center space-x-2">
            <span class="material-symbols-outlined text-orange-500">local_fire_department</span>
            <span>Fuego</span>
          </button>
        </div>
      </div>

      <div class="flex-grow space-y-2 flex flex-col">
        <p class="text-text/70 text-sm">Usuarios conectados</p>
        <div id="createUsers" class="flex-grow bg-glass rounded-lg p-2 min-h-[100px] flex flex-col space-y-2 overflow-y-auto"></div>
      </div>

      <div class="space-y-2">
        <div class="flex space-x-2">
          <input id="joinCodeInput" class="bg-glass border-glass rounded-lg w-full text-text placeholder-text/50 px-4 py-2 focus:ring-accent focus:border-accent" placeholder="Código de la sala" type="text"/>
          <button id="joinFromCreate" class="bg-accent text-background-dark font-bold py-2 px-4 rounded-lg shadow-[0_0_10px_#22d3ee]">Unirme</button>
        </div>
        <button id="shareCreate" class="w-full bg-violet text-text font-bold py-3 rounded-lg shadow-[0_0_10px_#a78bfa] mt-2">Compartir</button>
        <button id="startCreate" class="w-full bg-gradient-to-r from-orange-500 to-yellow-400 text-text font-bold py-3 rounded-lg shadow-[0_0_15px_rgba(255,165,0,0.6)] mt-2">Iniciar Partida</button>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const grid = $('grid');
  const statusEl = $('status');
  const turnEl = $('turn');
  const meEl = $('me');
  const markEl = $('myMark');
  const roomLinkEl = $('roomLink');
  const newBtn = $('newBtn');
  const copyBtn = $('copyBtn');
  const lobby = $('lobby');
  const roomView = $('roomView');
  const activeCard = $('activeCard');
  const countdownEl = $('countdown');
  const codeInput = $('codeInput');
  const joinCodeBtn = $('joinCodeBtn');
  const roomsList = $('roomsList');
  const publicRoomsList = $('publicRoomsList');
  // Crear sala: UI
  const fabCreate = $('fabCreate');
  const overlay = $('createOverlay');
  const closeCreate = $('closeCreate');
  const createCode = $('createCode');
  const optPrivate = $('optPrivate');
  const optPublic = $('optPublic');
  const optFree = $('optFree');
  const optFuego = $('optFuego');
  const joinCodeInput = $('joinCodeInput');
  const joinFromCreate = $('joinFromCreate');
  const shareCreate = $('shareCreate');
  const startCreate = $('startCreate');
  const timerValEl = $('timerVal');
  const scoreXVal = $('scoreXVal');
  const scoreOVal = $('scoreOVal');
  const afterRound = $('afterRound');
  const rematchBtn = document.getElementById('rematchBtn');
  let myId = null;
  let roomId = null;
  let myMark = null;
  let es = null;
  let countdownTimer = null;
  let lobbyES = null;
  let lobbyRoomId = null;
  let createVisibility = 'private';
  let createCostType = 'free';
  let createCostValue = 0;
  let createdRoomId = null;

  function getQuery(name){
    const u = new URL(window.location.href);
    return u.searchParams.get(name);
  }
  function setStatus(t){ statusEl.textContent = t; }
  function setTurn(t){ turnEl.textContent = t || '-'; }
  function setMyMark(m){ myMark = m; markEl.textContent = m || '-'; }
  function setRoom(r){ roomId = r; const link = `${location.origin}/games/tictactoe?room=${encodeURIComponent(r)}`; roomLinkEl.textContent = r; roomLinkEl.href = link; }
  function showLobby(){ lobby.classList.remove('hidden'); roomView.classList.add('hidden'); }
  function showRoom(){ roomView.classList.remove('hidden'); lobby.classList.add('hidden'); }

  function getUserId(){
    const tg = window.Telegram && window.Telegram.WebApp;
    const user = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;
    if (user && user.id) return 'tg:' + String(user.id);
    let anon = sessionStorage.getItem('anonId');
    if (!anon) { anon = 'anon:' + Math.random().toString(36).slice(2,10); sessionStorage.setItem('anonId', anon); }
    return anon;
  }

  function renderBoard(b){
    grid.innerHTML = '';
    for (let i=0;i<9;i++){
      const v = b[i];
      const btn = document.createElement('button');
      btn.className = 'cell bg-card border border-glass rounded-lg w-24 h-24 text-4xl font-bold flex items-center justify-center transition-all duration-150';
      btn.dataset.idx = String(i);
      btn.textContent = v ? v : '';
      if (!v) btn.addEventListener('click', onCell);
      grid.appendChild(btn);
    }
  }

  function fmtTime(ms){
    const s = Math.max(0, Math.ceil(ms/1000));
    const mm = String(Math.floor(s/60)).padStart(2,'0');
    const ss = String(s%60).padStart(2,'0');
    return `${mm}:${ss} seg`;
  }

  function updateActiveCard(room){
    try{ clearInterval(countdownTimer); }catch(_){ }
    const amI = (room.players && (room.players.X===myId ? 'X' : (room.players.O===myId ? 'O' : null)));
    const myTurn = amI && room.turn === amI;
    const deadline = room.turnDeadline ? Number(room.turnDeadline) : 0;
    if (room.status==='playing' && myTurn && deadline){
      activeCard.classList.remove('hidden');
      const tick = ()=>{
        const left = deadline - Date.now();
        countdownEl.textContent = fmtTime(left);
        if (left <= 0) { clearInterval(countdownTimer); countdownEl.textContent = '00:00 seg'; }
      };
      tick();
      countdownTimer = setInterval(tick, 250);
    } else {
      activeCard.classList.add('hidden');
    }
  }

  async function loadLobby(){
    showLobby();
    // lista de mis salas
    const r = await fetch(`/api/games/tictactoe/my-rooms?userId=${encodeURIComponent(myId)}`);
    const j = await r.json();
    roomsList.innerHTML = '';
    const arr = (j && j.success && Array.isArray(j.rooms)) ? j.rooms : [];
    if (!arr.length){
      const empty = document.createElement('div'); empty.className='text-center text-text/60'; empty.textContent='No has creado salas'; roomsList.appendChild(empty);
    } else {
      for (const rm of arr){
        const wrap = document.createElement('div');
        wrap.className = 'bg-card rounded-lg p-4 shadow-[0_0_8px_#21d5ed] border border-transparent';
        wrap.innerHTML = `<div class="flex justify-between items-center mb-2">
          <span class="text-accent font-mono text-lg">#${rm.code||'------'}</span>
          <a class="underline text-accent" href="/games/tictactoe?room=${encodeURIComponent(rm.id)}">Abrir</a>
        </div>
        <div class="flex justify-around text-center text-sm">
          <div><p class="font-bold text-lg">-</p><p class="text-text/60">V</p></div>
          <div><p class="font-bold text-lg">-</p><p class="text-text/60">E</p></div>
          <div><p class="font-bold text-lg">-</p><p class="text-text/60">D</p></div>
        </div>`;
        roomsList.appendChild(wrap);
      }
    }

    // si hay sala con mi turno, mostrar countdown
    const playingMine = arr.find(rm=> (rm.players&& (rm.players.X===myId||rm.players.O===myId)) && rm.status==='playing');
    if (playingMine) {
      updateActiveCard(playingMine);
      // Suscripción SSE a la sala activa para countdown en vivo
      if (lobbyRoomId !== playingMine.id) {
        try { lobbyES && lobbyES.close && lobbyES.close(); } catch(_){}
        lobbyRoomId = playingMine.id;
        lobbyES = new EventSource(`/api/games/tictactoe/rooms/${encodeURIComponent(lobbyRoomId)}/stream`);
        lobbyES.addEventListener('state', (ev) => {
          try { const s = JSON.parse(ev.data); updateActiveCard(s); } catch(_){}
        });
      }
    } else {
      activeCard.classList.add('hidden');
      try { lobbyES && lobbyES.close && lobbyES.close(); } catch(_){}
      lobbyES = null; lobbyRoomId = null;
    }

    // listar salas públicas
    try {
      const rp = await fetch('/api/games/tictactoe/public-rooms');
      const jp = await rp.json();
      publicRoomsList.innerHTML = '';
      const parr = (jp && jp.success && Array.isArray(jp.rooms)) ? jp.rooms : [];
      if (!parr.length) {
        const empty = document.createElement('div'); empty.className='text-center text-text/60'; empty.textContent='Sin salas públicas'; publicRoomsList.appendChild(empty);
      } else {
        for (const rm of parr){
          const wrap = document.createElement('div');
          wrap.className = 'bg-card rounded-lg p-4 border border-glass flex items-center justify-between';
          wrap.innerHTML = `<span class="text-accent font-mono">#${rm.code||'------'}</span>
            <a class="underline text-accent" href="/games/tictactoe?room=${encodeURIComponent(rm.id)}">Abrir</a>`;
          publicRoomsList.appendChild(wrap);
        }
      }
    } catch (_) {}
  }

  async function createRoom(){
    const payload = { userId: myId, visibility: createVisibility, costType: createCostType, costValue: createCostValue };
    const r = await fetch('/api/games/tictactoe/rooms', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    const j = await r.json();
    if (!j.success) throw new Error('create_failed');
    setRoom(j.state.id);
    subscribe();
    showRoom();
    // actualizar modal si abierto
    createdRoomId = j.state.id;
    createCode.textContent = j.state.code || '------';
  }
  async function joinRoom(id){
    const r = await fetch(`/api/games/tictactoe/rooms/${encodeURIComponent(id)}/join`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: myId }) });
    const j = await r.json();
    if (!j.success) throw new Error(j.error || 'join_failed');
    setRoom(j.state.id);
    subscribe();
    showRoom();
  }

  function subscribe(){
    if (!roomId) return;
    es && es.close && es.close();
    es = new EventSource(`/api/games/tictactoe/rooms/${encodeURIComponent(roomId)}/stream`);
    es.addEventListener('state', (ev) => {
      try{
        const s = JSON.parse(ev.data);
        renderBoard(s.board || Array(9).fill(null));
        setTurn(s.turn);
        setStatus(s.status + (s.winner ? (s.winner==='draw' ? ' (Empate)' : ` (Ganador: ${s.winner})`) : ''));
        // define my mark
        if (!myMark && s.players){
          if (s.players.X === myId) setMyMark('X');
          else if (s.players.O === myId) setMyMark('O');
        }
        // actualizar countdown visible si volvemos al lobby
        updateActiveCard(s);
        // actualizar temporizador en vista de sala
        if (s.turnDeadline && timerValEl) {
          const left = Number(s.turnDeadline) - Date.now();
          timerValEl.textContent = fmtTime(left);
        }
        // marcador
        if (s.score) {
          if (scoreXVal) scoreXVal.textContent = String(s.score.X||0);
          if (scoreOVal) scoreOVal.textContent = String(s.score.O||0);
        }
        // controles de revancha
        if (afterRound) afterRound.style.display = (s.status === 'finished') ? 'flex' : 'none';
      }catch(_){}
    });
  }

  async function onCell(e){
    const idx = Number(e.currentTarget.dataset.idx);
    if (!Number.isFinite(idx) || roomId===null) return;
    // intento de jugada
    try{
      const r = await fetch(`/api/games/tictactoe/rooms/${encodeURIComponent(roomId)}/move`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: myId, index: idx }) });
      const j = await r.json();
      if (!j.success) throw new Error(j.error||'move_failed');
      // feedback dorado en la casilla pulsada
      e.currentTarget.classList.add('selected');
      setTimeout(()=> e.currentTarget.classList.remove('selected'), 500);
    }catch(err){
      setStatus('Movimiento inválido: ' + (err.message||'error'));
      setTimeout(()=> setStatus(''), 1500);
    }
  }

  // init
  (async function init(){
    myId = getUserId();
    meEl.textContent = myId;
    const rid = getQuery('room');
    if (rid) {
      await joinRoom(rid).catch(()=>createRoom());
    } else {
      await loadLobby();
    }
  })();

  newBtn.addEventListener('click', async ()=>{
    await createRoom();
  });
  copyBtn.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(roomLinkEl.href); copyBtn.textContent='Copiado'; setTimeout(()=>copyBtn.textContent='Copiar enlace', 1200);}catch(_){ }
  });

  joinCodeBtn.addEventListener('click', async ()=>{
    const code = (codeInput.value||'').trim();
    if (!code) return;
    try{
      const r = await fetch('/api/games/tictactoe/join-code', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code, userId: myId }) });
      const j = await r.json();
      if (j && j.success && j.state && j.state.id) {
        setRoom(j.state.id); subscribe(); showRoom();
      }
    }catch(_){ }
  });

  // Crear sala: handlers
  function openCreate(){ overlay.classList.remove('hidden'); createdRoomId = null; createCode.textContent='------'; }
  function closeCreateOverlay(){ overlay.classList.add('hidden'); }
  function styleToggle(btnOn, btnOff, onClasses, offClasses){
    btnOn.className = (btnOn.className.replace(' bg-glass','').replace(' text-text','') + onClasses);
    btnOff.className = (btnOff.className.replace(' bg-accent text-background-dark','').replace(' shadow-[0_0_10px_#22d3ee]','') + offClasses);
  }
  optPrivate.addEventListener('click', ()=>{ createVisibility='private'; styleToggle(optPrivate,optPublic,' bg-accent text-background-dark shadow-[0_0_10px_#22d3ee]',' bg-glass text-text'); });
  optPublic.addEventListener('click', ()=>{ createVisibility='public'; styleToggle(optPublic,optPrivate,' bg-accent text-background-dark shadow-[0_0_10px_#22d3ee]',' bg-glass text-text'); });
  optFree.addEventListener('click', ()=>{ createCostType='free'; createCostValue=0; styleToggle(optFree,optFuego,' bg-yellow-400/20 text-yellow-400 shadow-[0_0_10px_#facc15]',' bg-glass text-text'); });
  optFuego.addEventListener('click', ()=>{ createCostType='fuego'; createCostValue=1; styleToggle(optFuego,optFree,' bg-yellow-400/20 text-yellow-400 shadow-[0_0_10px_#facc15]',' bg-glass text-text'); });
  fabCreate.addEventListener('click', openCreate);
  closeCreate.addEventListener('click', closeCreateOverlay);
  // Al abrir creación, crear sala inmediatamente con opciones por defecto
  async function openCreate(){
    overlay.classList.remove('hidden');
    if (!createdRoomId) {
      try { await createRoom(); } catch (_) {}
    }
  }
  function closeCreateOverlay(){ overlay.classList.add('hidden'); }
  shareCreate.addEventListener('click', async ()=>{
    if (!createdRoomId) return; const link = `${location.origin}/games/tictactoe?room=${encodeURIComponent(createdRoomId)}`; try{ await navigator.clipboard.writeText(link); shareCreate.textContent='Copiado'; setTimeout(()=>shareCreate.textContent='Compartir', 1200);}catch(_){ }
  });
  startCreate.addEventListener('click', async ()=>{
    // Si no hay sala creada aún, crearla; luego unirse
    if (!createdRoomId) { await createRoom().catch(()=>{}); }
    if (createdRoomId) {
      await joinRoom(createdRoomId).catch(()=>{});
      closeCreateOverlay();
    }
  });
  if (rematchBtn) rematchBtn.addEventListener('click', async ()=>{
    if (!roomId) return;
    try{
      const r = await fetch(`/api/games/tictactoe/rooms/${encodeURIComponent(roomId)}/rematch`, { method:'POST' });
      const j = await r.json();
      if (j && j.success) { afterRound.style.display='none'; }
    }catch(_){ }
  });
  joinFromCreate.addEventListener('click', async ()=>{
    const code = (joinCodeInput.value||'').trim(); if (!code) return;
    try{
      const r = await fetch('/api/games/tictactoe/join-code', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code, userId: myId }) });
      const j = await r.json();
      if (j && j.success && j.state && j.state.id) { setRoom(j.state.id); subscribe(); showRoom(); closeCreateOverlay(); }
    }catch(_){ }
  });
})();
</script>
</body>
</html>
