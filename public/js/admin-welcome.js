function adminHeaders(){ try{ const u=document.getElementById('wel-admin-user')?.value||''; const c=document.getElementById('wel-admin-code')?.value||''; if(!u||!c) return {}; return {'x-admin-username':u,'x-admin-code':c,'Content-Type':'application/json'}; }catch(_){ return {'Content-Type':'application/json'}; } }
function vigenciaText(it){ try{ if(!it.startsAt||!it.endsAt) return '-'; return new Date(it.startsAt).toLocaleString()+' â€“ '+new Date(it.endsAt).toLocaleString(); }catch(_){ return '-'; } }
function renderWelcomeRows(items){ const tb=document.getElementById('wel-rows'); if(!tb) return; tb.innerHTML=''; (items||[]).forEach(it=>{ const tr=document.createElement('tr'); tr.innerHTML=`
      <td>${it.name||'-'}</td>
      <td><code>${(typeof shortTxt==='function'?shortTxt(String(it.message||''),48):String(it.message||'').slice(0,48))}${(String(it.message||'').length>48?'...':'')}</code></td>
      <td>${(typeof fmt==='function'?fmt(it.coins||0):(it.coins||0))}</td>
      <td>${(typeof fmt==='function'?fmt(it.fires||0):(it.fires||0))}</td>
      <td>${(typeof fmt==='function'?fmt(it.durationHours||0):(it.durationHours||0))}</td>
      <td>${vigenciaText(it)}</td>
      <td><input type="checkbox" class="wel-tgl" data-id="${it.id}" ${it.active?'checked':''}/></td>
      <td><button class="btn btn-small wel-edit" data-id="${it.id}" data-name="${(it.name||'').replace(/"/g,'&quot;')}" data-message="${(it.message||'').replace(/"/g,'&quot;')}" data-coins="${it.coins||0}" data-fires="${it.fires||0}" data-hours="${it.durationHours||0}">Editar</button></td>
    `; tb.appendChild(tr); }); attachWelcomeHandlers(); }
async function loadWelcomeEvents(){ const alertEl=document.getElementById('wel-alert'); if(alertEl) alertEl.textContent=''; try{ const r=await fetch('/api/admin/welcome/events?includeInactive=true',{ headers: adminHeaders()}); const j=await r.json(); if(j&&j.success){ renderWelcomeRows(j.items||[]); } else { if(alertEl) alertEl.textContent='Error al cargar eventos'; } }catch(_){ const tb=document.getElementById('wel-rows'); if(tb) tb.innerHTML='<tr><td colspan="8">Error de red</td></tr>'; } }
function openWelModal(data){ const m=document.getElementById('wel-modal'); if(!m) return; m.style.display='flex'; const t=document.getElementById('wel-modal-title'); if(t) t.textContent = data&&data.id? 'Editar evento' : 'Nuevo evento'; m.dataset.editingId = data&&data.id? String(data.id):''; const n=document.getElementById('wel-m-name'); if(n) n.value= data?.name||''; const mm=document.getElementById('wel-m-message'); if(mm) mm.value= data?.message||''; const c=document.getElementById('wel-m-coins'); if(c) c.value= data?.coins||0; const f=document.getElementById('wel-m-fires'); if(f) f.value= data?.fires||0; const h=document.getElementById('wel-m-hours'); if(h) h.value= data?.durationHours||72; }
function closeWelModal(){ const m=document.getElementById('wel-modal'); if(!m) return; m.style.display='none'; m.dataset.editingId=''; }
async function saveWelModal(){ const m=document.getElementById('wel-modal'); if(!m) return; const id=m.dataset.editingId||''; const payload={ name:(document.getElementById('wel-m-name')?.value||''), message:(document.getElementById('wel-m-message')?.value||''), coins:parseInt(document.getElementById('wel-m-coins')?.value||'0',10)||0, fires:parseInt(document.getElementById('wel-m-fires')?.value||'0',10)||0, durationHours:parseInt(document.getElementById('wel-m-hours')?.value||'0',10)||0 }; const alertEl=document.getElementById('wel-alert'); if(alertEl) alertEl.textContent=''; try{ let r; if(id){ r=await fetch(`/api/admin/welcome/events/${id}`,{ method:'PATCH', headers: adminHeaders(), body: JSON.stringify(payload)}); } else { r=await fetch('/api/admin/welcome/events',{ method:'POST', headers: adminHeaders(), body: JSON.stringify(payload)}); } const j=await r.json(); if(j&&j.success){ closeWelModal(); await loadWelcomeEvents(); } else { if(alertEl) alertEl.textContent='Error al guardar'; } }catch(_){ if(alertEl) alertEl.textContent='Error de red'; } }
async function setWelActive(id, on){ const alertEl=document.getElementById('wel-alert'); if(alertEl) alertEl.textContent=''; try{ const url = on? `/api/admin/welcome/events/${id}/activate` : `/api/admin/welcome/events/${id}/deactivate`; const body = on? JSON.stringify({ startsAt: new Date().toISOString() }) : null; const r = await fetch(url, { method:'POST', headers: adminHeaders(), body }); const j=await r.json(); if(!(j&&j.success)){ if(alertEl) alertEl.textContent='No se pudo cambiar estado'; } await loadWelcomeEvents(); }catch(_){ if(alertEl) alertEl.textContent='Error de red'; await loadWelcomeEvents(); } }
function attachWelcomeHandlers(){ document.querySelectorAll('.wel-edit').forEach(b=>{ b.addEventListener('click', (e)=>{ const el=e.currentTarget; openWelModal({ id: el.getAttribute('data-id'), name: el.getAttribute('data-name')||'', message: el.getAttribute('data-message')||'', coins: parseInt(el.getAttribute('data-coins')||'0',10)||0, fires: parseInt(el.getAttribute('data-fires')||'0',10)||0, durationHours: parseInt(el.getAttribute('data-hours')||'0',10)||0 }); }); }); document.querySelectorAll('.wel-tgl').forEach(ch=>{ ch.addEventListener('change', (e)=>{ const el=e.currentTarget; el.disabled=true; setWelActive(el.getAttribute('data-id'), el.checked).finally(()=>{ el.disabled=false; }); }); }); }
document.addEventListener('DOMContentLoaded', ()=>{ if(document.getElementById('wel-rows')){ const welRef=document.getElementById('wel-refresh'); if(welRef) welRef.addEventListener('click', loadWelcomeEvents); const welNew=document.getElementById('wel-new'); if(welNew) welNew.addEventListener('click', ()=> openWelModal(null)); const welCancel=document.getElementById('wel-m-cancel'); if(welCancel) welCancel.addEventListener('click', closeWelModal); const welSave=document.getElementById('wel-m-save'); if(welSave) welSave.addEventListener('click', saveWelModal); loadWelcomeEvents(); }});
