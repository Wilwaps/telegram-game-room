<!DOCTYPE html>
<html class="dark" lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard • Usuarios</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script id="tailwind-config">tailwind.config={darkMode:'class',theme:{extend:{colors:{accent:'#22d3ee','background-dark':'#0B0E14',card:'#121A2B',glass:'rgba(255,255,255,0.1)',text:'#E6EDF3'},fontFamily:{display:['Space Grotesk']},borderRadius:{DEFAULT:'0.5rem'}}}}</script>
  <style>body{min-height:100dvh} .badge{border-radius:9999px;padding:2px 8px;font-size:11px} .online{background:#16a34a22;color:#22c55e} .offline{background:#ef444422;color:#ef4444} table{width:100%;border-collapse:separate;border-spacing:0 8px} thead th{font-size:12px;text-align:left;color:#9ba3af} tbody tr{background:#0f1524;border:1px solid rgba(255,255,255,.08)} tbody td{padding:10px 12px;font-size:13px}</style>
</head>
<body class="bg-background-dark text-text font-display">
  <div class="max-w-6xl mx-auto p-4 space-y-4">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold text-accent">Usuarios Conectados</h1>
      <div class="flex gap-2 items-center">
        <input id="q" class="bg-card border border-glass rounded-lg px-3 py-1.5" placeholder="Buscar..."/>
        <label class="text-sm flex items-center gap-1"><input id="onlineOnly" type="checkbox" class="rounded" checked/> Solo Online</label>
        <button id="refreshBtn" class="bg-accent text-background-dark px-3 py-1.5 rounded-lg font-bold">Refrescar</button>
        <button id="adminCredBtn" class="bg-[#1f2937] border border-glass px-3 py-1.5 rounded-lg">Credenciales</button>
      </div>
    </div>
    <div class="grid md:grid-cols-2 gap-3">
      <div class="bg-card rounded-lg p-3 border border-glass space-y-2">
        <div class="font-semibold">Crear usuario</div>
        <div class="grid grid-cols-2 gap-2">
          <input id="new_username" class="bg-background-dark border border-glass rounded px-2 py-1" placeholder="Usuario"/>
          <input id="new_password" type="password" class="bg-background-dark border border-glass rounded px-2 py-1" placeholder="Contraseña"/>
          <input id="new_display" class="bg-background-dark border border-glass rounded px-2 py-1" placeholder="Nombre"/>
          <input id="new_email" class="bg-background-dark border border-glass rounded px-2 py-1" placeholder="Email"/>
          <input id="new_phone" class="bg-background-dark border border-glass rounded px-2 py-1" placeholder="Teléfono"/>
          <select id="new_role" class="bg-background-dark border border-glass rounded px-2 py-1"></select>
        </div>
        <div class="flex gap-2">
          <button id="createUserBtn" class="bg-accent text-background-dark px-3 py-1.5 rounded-lg font-bold">Crear</button>
          <span id="createStatus" class="text-sm"></span>
        </div>
      </div>
    </div>
    <div class="overflow-x-auto">
      <table>
        <thead>
          <tr>
            <th>Inicio</th>
            <th>Últ. visto</th>
            <th>ID Plataforma</th>
            <th>ID Telegram</th>
            <th>Usuario / Nombre</th>
            <th>Teléfono</th>
            <th>Correo</th>
            <th>Fuegos</th>
            <th>Monedas</th>
            <th>Último dispositivo</th>
            <th>Esperado</th>
            <th>Coincide</th>
            <th>Rol</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
    <div id="rowsMeta" class="text-xs text-text/60"></div>
  </div>
  <script>
  (function(){
    const $ = (id)=>document.getElementById(id);
    const rows = $('rows');
    const rowsMeta = $('rowsMeta');
    const numberFmt = new Intl.NumberFormat();
    function fmt(n){ return numberFmt.format(Number(n||0)); }
    function fmtTS(t){ if(!t) return '-'; try{ return new Date(Number(t)).toLocaleString(); }catch(_){ return '-'; } }
    function fmtDur(ms){ const n=Math.max(0,Number(ms||0)); if(n===0) return '0s'; const s=Math.floor(n/1000); if(s<60) return `${s}s`; const m=Math.floor(s/60); if(m<60) return `${m}m ${s%60}s`; const h=Math.floor(m/60); if(h<24) return `${h}h ${m%60}m`; const d=Math.floor(h/24); return `${d}d ${h%24}h`; }
    function shortTxt(text,max=36){ const s=String(text||''); return s.length>max?`${s.slice(0,max-3)}...`:s; }
    function adminHeaders(){ try{ const u=localStorage.getItem('adminUser')||''; const c=localStorage.getItem('adminCode')||''; if(!u||!c) return {}; return {'x-admin-username':u,'x-admin-code':c}; }catch(_){ return {}; } }
    function hasAdmin(){ const h=adminHeaders(); return !!(h['x-admin-username']&&h['x-admin-code']); }
    function guessOnline(lastSeen, windowMs){ if(!lastSeen) return false; const win=Math.max(15_000, Number(windowMs||120_000)); return (Date.now()-Number(lastSeen)) < win; }
    function normalizeUser(raw, source, onlineWindowMs){
      const u=raw||{};
      const baseId=String(u.userId||u.id||u.username||'').trim();
      const createdAt=Number(u.created_at ?? u.createdAt ?? u.firstSeenAt ?? 0);
      const lastSeenAt=Number(u.last_seen_at ?? u.lastSeenAt ?? u.updated_at ?? 0);
      const email=String(u.email||'').trim();
      const phone=String(u.phone||'').trim();
      const userName=u.userName || u.username || u.display_name || u.name || '';
      const fires=Number(u.fires ?? u.fires_balance ?? 0);
      const coins=Number(u.coins ?? u.coins_balance ?? 0);
      const rolesRaw=u.roles;
      const roles=Array.isArray(rolesRaw)?rolesRaw.join(','):String(rolesRaw||'');
      const telegramRaw = u.telegramId ?? u.telegram_id ?? (baseId.startsWith('tg:') ? baseId.slice(3) : '');
      const telegramId = String(telegramRaw || '').trim();
      const expectedId = u.expectedId || (telegramId ? `tg:${telegramId}` : (email ? `em:${email.toLowerCase()}` : null));
      const idMatch = (typeof u.idMatch === 'boolean') ? u.idMatch : (!expectedId || !baseId ? true : expectedId.toLowerCase() === baseId.toLowerCase());
      const lastDevice = u.lastDevice || u.last_device || '';
      const lastDurationMs = Number(u.lastDurationMs ?? u.last_duration_ms ?? 0);
      const isOnline = (typeof u.isOnline === 'boolean') ? u.isOnline : guessOnline(lastSeenAt, onlineWindowMs);
      return { source, raw:u, key: baseId || String(u.id||''), createdAt, lastSeenAt, email, phone, userName, fires, coins, roles, telegramId, expectedId, idMatch, lastDevice, lastDurationMs, userId: baseId, isOnline, onlineWindowMs };
    }
    async function load(){
      const q = $('q').value||''; const onlineOnly = $('onlineOnly').checked; let data=null; let source='memory'; let onlineWindowMs=120000;
      try{
        const rdb = await fetch(`/api/admin/users/db-list?search=${encodeURIComponent(q)}&limit=100&offset=0`, { headers: adminHeaders() });
        if (rdb.ok) { const dj = await rdb.json(); if (dj && dj.success) { data = dj; source = 'db'; } }
      }catch(_){ }
      if (!data) {
        const r = await fetch(`/api/admin/users/list?search=${encodeURIComponent(q)}&onlineOnly=${onlineOnly}`);
        const mj = await r.json();
        if (mj && mj.success) { data = mj; source = 'memory'; }
      }
      rows.innerHTML='';
      const arrRaw = (data && Array.isArray(data.items)) ? data.items : [];
      if (data && typeof data.onlineWindowMs === 'number') onlineWindowMs = data.onlineWindowMs;
      const normalized = arrRaw.map(u=>normalizeUser(u, source, onlineWindowMs));
      for (const u of normalized){
        const tr = document.createElement('tr');
        if (u.idMatch === false) tr.style.outline = '1px solid rgba(239,68,68,.6)';
        tr.__data = u;
        const key = u.key || u.userId || '';
        const tgDisplay = u.telegramId ? `tg:${u.telegramId}` : '-';
        const roleList = (u.roles||'').split(',').map(s=>s.trim()).filter(Boolean);
        tr.innerHTML = `
          <td>${fmtTS(u.createdAt)}</td>
          <td>${fmtTS(u.lastSeenAt)} <span class="badge ${u.isOnline?'online':'offline'}">${u.isOnline?'online':'offline'}</span><div class="text-xs text-text/40">${fmtDur(u.lastDurationMs)}</div></td>
          <td class="font-mono">${u.userId||'-'}</td>
          <td class="font-mono">${tgDisplay}</td>
          <td>${u.userName||'-'}</td>
          <td><input data-key="${key}" data-field="phone" class="bg-card border border-glass rounded px-2 py-1 w-36" value="${u.phone||''}"/></td>
          <td><input data-key="${key}" data-field="email" class="bg-card border border-glass rounded px-2 py-1 w-52" value="${u.email||''}"/></td>
          <td class="text-orange-400 font-bold">${fmt(u.fires)}</td>
          <td class="text-accent font-bold">${fmt(u.coins)}</td>
          <td><code>${shortTxt(u.lastDevice||'-', 42)}</code></td>
          <td class="font-mono">${u.expectedId||'-'}</td>
          <td>${u.idMatch?'<span class="badge online">OK</span>':'<span class="badge offline">NO</span>'}</td>
          <td>
            <select class="roleSel bg-card border border-glass rounded px-2 py-1" data-key="${key}" data-roles="${roleList.join(',')}"></select>
          </td>
          <td>
            <button data-key="${key}" class="save bg-accent text-background-dark px-2 py-1 rounded mr-1">Guardar</button>
            ${(!u.idMatch && u.expectedId)?`<button data-secondary="${key}" data-primary="${u.expectedId}" class="merge bg-red-500/80 text-text px-2 py-1 rounded">Arreglar</button>`:''}
          </td>
        `;
        rows.appendChild(tr);
      }
      if (rowsMeta){
        const ts = new Date().toLocaleString();
        rowsMeta.textContent = `Fuente: ${source === 'db' ? 'Base de datos' : 'Memoria en tiempo real'} · Registros: ${normalized.length} · Ventana online: ${Math.round(onlineWindowMs/1000)}s · Actualizado: ${ts}`;
      }
      bind();
    }
    function bind(){
      // Rellenar selects de rol
      const roleOptions = window.__rolesCache || [];
      for (const sel of document.querySelectorAll('select.roleSel')){
        sel.innerHTML = roleOptions.map(r=>`<option value="${r.name}">${r.name}</option>`).join('');
        const tr = sel.closest('tr');
        const rolesStr = (tr?.__data && tr.__data.roles) || '';
        const current = String((rolesStr||'').split(',')[0]||'client');
        sel.value = current || 'client';
        sel.addEventListener('change', async (e)=>{
          if (!hasAdmin()) return alert('Faltan credenciales admin');
          const id = e.currentTarget.getAttribute('data-key');
          try{
            const r = await fetch('/api/admin/users/set-role', { method:'POST', headers:{ 'Content-Type':'application/json', ...adminHeaders() }, body: JSON.stringify({ userId:id, role: e.currentTarget.value })});
            const j = await r.json(); if (!(j&&j.success)) alert('No se pudo asignar rol');
          }catch(_){ alert('Error de red'); }
        });
      }
      for (const btn of document.querySelectorAll('button.save')){
        btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.getAttribute('data-key');
          const email = document.querySelector(`input[data-key="${id}"][data-field="email"]`)?.value||'';
          const phone = document.querySelector(`input[data-key="${id}"][data-field="phone"]`)?.value||'';
          try{
            const url = hasAdmin()? '/api/admin/users/db-set-contact' : '/api/admin/users/set-contact';
            const headers = hasAdmin()? { 'Content-Type':'application/json', ...adminHeaders() } : { 'Content-Type':'application/json' };
            const r = await fetch(url,{ method:'POST', headers, body: JSON.stringify({ userId:id, email, phone }) });
            const j = await r.json();
            if (j && j.success) { e.currentTarget.textContent='Guardado'; setTimeout(()=> e.currentTarget.textContent='Guardar', 1000); }
          } catch(_){ alert('No se pudo guardar'); }
        });
      }
      for (const btn of document.querySelectorAll('button.merge')){
        btn.addEventListener('click', async (e)=>{
          const secondaryId = e.currentTarget.getAttribute('data-secondary');
          const primaryId = e.currentTarget.getAttribute('data-primary');
          if (!primaryId || !secondaryId || primaryId===secondaryId) return;
          try{
            const r = await fetch('/api/admin/users/merge',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ primaryId, secondaryId }) });
            const j = await r.json();
            if (j && j.success){ await load(); }
            else { alert('No se pudo fusionar'); }
          }catch(_){ alert('Error de red'); }
        });
      }
    }
    $('adminCredBtn').addEventListener('click', ()=>{ try{ const u=prompt('Usuario admin'); const c=prompt('Código admin'); if(u&&c){ localStorage.setItem('adminUser',u); localStorage.setItem('adminCode',c); loadRoles(); } }catch(_){ } });
    async function loadRoles(){ try{ const r = await fetch('/api/admin/users/db-roles',{ headers: adminHeaders() }); if(!r.ok) return; const j = await r.json(); const sel = $('new_role'); sel.innerHTML=''; const roles=(j&&j.roles)||[]; window.__rolesCache = roles; for(const it of roles){ const opt=document.createElement('option'); opt.value=it.name; opt.textContent=it.name; sel.appendChild(opt);} }catch(_){ } }
    $('createUserBtn').addEventListener('click', async ()=>{
      const username = $('new_username').value||''; const password = $('new_password').value||''; const role = $('new_role').value||'client';
      const email = $('new_email').value||''; const phone = $('new_phone').value||''; const displayName = $('new_display').value||'';
      const st = $('createStatus'); st.textContent='';
      try{
        const r = await fetch('/api/admin/users/create',{ method:'POST', headers:{ 'Content-Type':'application/json', ...adminHeaders() }, body: JSON.stringify({ username, password, role, email, phone, displayName }) });
        const j = await r.json();
        if (j && j.success){ st.textContent='Creado'; $('new_username').value=''; $('new_password').value=''; await load(); setTimeout(()=> st.textContent='', 1500); }
        else { st.textContent=j.error||'Error'; }
      }catch(_){ st.textContent='Error de red'; }
    });
    $('refreshBtn').addEventListener('click', load);
    $('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') load(); });
    $('onlineOnly').addEventListener('change', load);
    loadRoles(); load(); setInterval(load, 10000);
  })();
  </script>
  </body>
  </html>
