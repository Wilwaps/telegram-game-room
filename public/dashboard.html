<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard • Telegram Game Room</title>
  <style>
    :root { --bg:#0b0e14; --panel:#0f1524; --card:#121a2b; --fg:#e6edf3; --muted:#9fb1c6; --accent:#22d3ee; --ok:#34d399; --warn:#f59e0b; --err:#ef4444; }
    html, body { height: 100%; }
    body { margin:0; background:
      radial-gradient(800px 500px at 10% -10%, rgba(34,211,238,.14), transparent),
      radial-gradient(900px 500px at 110% -20%, rgba(139,92,246,.10), transparent),
      var(--bg);
      color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand { font-weight: 800; letter-spacing:.35px; font-size: 20px; }
    .pill { display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#bfefff; border:1px solid rgba(34,211,238,.4); padding:5px 10px; border-radius:999px; background: rgba(34,211,238,.10); }
    .subtitle { color:var(--muted); margin-top:6px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:16px; margin-top: 18px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.06); border-radius: 14px; padding:16px; box-shadow: 0 6px 24px rgba(0,0,0,.25); backdrop-filter: blur(6px); }
    .kpi { font-size: 28px; font-weight: 800; }
    .label { color: var(--muted); font-size: 13px; }
    .list { display:flex; flex-direction:column; gap:8px; max-height: 260px; overflow:auto; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:10px; border:1px solid rgba(255,255,255,.06); border-radius:10px; padding:8px 10px; background: rgba(255,255,255,.02); font-size:13px; }
    .muted { color: var(--muted); }
    .nav { display:flex; gap:8px; flex-wrap:wrap; }
    .btn { display:inline-flex; align-items:center; gap:8px; background: rgba(34,211,238,0.1); border:1px solid rgba(34,211,238,0.35); color:#e6fbff; padding:10px 14px; border-radius:10px; cursor:pointer; text-decoration:none; transition:.18s ease; }
    .btn:hover { transform: translateY(-1px); background: rgba(34,211,238,0.16); }
    .btn-small { padding:6px 10px; font-size:12px; border-radius:8px; }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .btn-tab { display:inline-flex; align-items:center; padding:6px 12px; border-radius:999px; border:1px solid rgba(34,211,238,0.35); background: rgba(34,211,238,0.1); color:#bfefff; font-size:12px; cursor:pointer; transition:.18s ease; }
    .btn-tab:hover { background: rgba(34,211,238,0.18); }
    .btn-tab-active { background: rgba(34,211,238,0.3); color:#0b0e14; border-color: rgba(34,211,238,0.8); }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px }
    .tbl { width:100%; border-collapse:separate; border-spacing:0 6px; }
    .tbl th { text-align:left; font-size:12px; color: var(--muted); }
    .tbl td { padding:8px 10px; font-size:12px; }
    .ok { color:#34d399; font-weight:700 }
    .bad { color:#ef4444; font-weight:700 }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div>
        <div class="brand">Dashboard</div>
        <div class="subtitle">Supply, transacciones y usuarios (real-time)</div>
      </div>


      <div class="nav">
        <a class="btn" href="/portal.html">Portal</a>
        <a class="btn" href="/">Home</a>
      </div>
    </div>

    

    <!-- Usuarios conectados (ancho completo al inicio) -->
    <div class="grid" style="grid-template-columns: 1fr;">
      <div class="card">
        <div class="label">Usuarios conectados</div>
        <div style="display:flex; gap:8px; align-items:center; margin:8px 0 10px;">
          <input id="au-q" type="text" placeholder="Buscar..." style="flex:1; padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.04); color: var(--fg);"/>
          <label class="muted" style="display:flex; gap:6px; align-items:center;"><input id="au-online" type="checkbox" checked/> Solo online</label>
          <button id="au-refresh" class="btn">Refrescar</button>
        </div>
        <div style="max-height:60vh; overflow:auto;">
          <table class="tbl">
            <thead>
              <tr>
                <th>Inicio</th>
                <th>Últ. visto</th>
                <th>ID</th>
                <th>TG</th>
                <th>Correo</th>
                <th>Tel</th>
                <th>Fuegos</th>
                <th>Esperado</th>
                <th>OK</th>
              </tr>
            </thead>
            <tbody id="au-rows"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="grid">
      <div class="card">
        <div class="label">Total supply</div>
        <div class="kpi" id="total">-</div>
      </div>
      <div class="card">
        <div class="label">Circulating</div>
        <div class="kpi" id="circ">-</div>
      </div>
      <div class="card">
        <div class="label">Burned</div>
        <div class="kpi" id="burn">-</div>
      </div>
      <div class="card">
        <div class="label">Reserva</div>
        <div class="kpi" id="reserve">-</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="label">Últimas transacciones de supply</div>
        <div id="txs" class="list"></div>
      </div>
      <div class="card">
        <div class="label">XP thresholds (config)</div>
        <div class="list" id="xp"></div>
      </div>
    </div>

    <div class="grid" style="grid-template-columns: 1fr;">
      <div class="card">
        <div class="label">Evento de bienvenida</div>
        <div class="row" style="justify-content:flex-start; gap:12px;">
          <span class="muted">Estado</span>
          <span id="wel-status" class="kpi" style="font-size:18px">-</span>
        </div>
        <div class="list" id="wel-info"></div>
        <hr style="border:none; border-top:1px solid rgba(255,255,255,.08); margin:12px 0;">
        <div class="row"><span class="muted">Monedas</span><input id="wel-coins" type="number" min="0" value="100" style="width:120px"/></div>
        <div class="row"><span class="muted">Fuegos</span><input id="wel-fires" type="number" min="0" value="10" style="width:120px"/></div>
        <div class="row"><span class="muted">Duración (horas)</span><input id="wel-hours" type="number" min="1" value="72" style="width:120px"/></div>
        <div class="row"><span class="muted">Mensaje</span><input id="wel-msg" type="text" placeholder="Texto mostrado a usuarios" style="flex:1"/></div>
        <div class="row"><span class="muted">Admin</span>
          <input id="wel-admin-user" type="text" placeholder="usuario" style="width:140px"/>
          <input id="wel-admin-code" type="password" placeholder="código" style="width:140px"/>
        </div>
        <div class="row" style="justify-content:flex-end; gap:8px;">
          <button id="wel-refresh" class="btn btn-small">Actualizar estado</button>
          <button id="wel-apply" class="btn btn-small" style="border-color:#34d399; color:#d1fae5; background:rgba(52,211,153,.1)">Guardar y activar</button>
          <button id="wel-disable" class="btn btn-small" style="border-color:#ef4444; color:#fee2e2; background:rgba(239,68,68,.1)">Desactivar</button>
        </div>
        <div id="wel-alert" class="muted"></div>
      </div>
    </div>

  </div>

  <script>
    const fmt = (n) => new Intl.NumberFormat().format(n ?? 0);
    const $ = (id) => document.getElementById(id);

    async function loadSupply(){
      const r = await fetch('/api/economy/supply');
      const j = await r.json();
      if(j && j.success){
        $('total').textContent = fmt(j.supply.total);
        $('circ').textContent  = fmt(j.supply.circulating);
        $('burn').textContent  = fmt(j.supply.burned);
        const rv=$('reserve'); if(rv) rv.textContent=fmt(j.supply.reserve||0);
      }
    }

    function fmtDur(ms){
      const n = Math.max(0, Number(ms||0));
      const s = Math.floor(n/1000); if (s < 60) return `${s}s`;
      const m = Math.floor(s/60); if (m < 60) return `${m}m ${s%60}s`;
      const h = Math.floor(m/60); return `${h}h ${m%60}m`;
    }

    function shortTxt(s, max=64){ const t = String(s||''); return t.length>max? (t.slice(0,max-3)+"...") : t; }

    // Paginación y pestañas (Consolidado)
    const fuState = { tab: 'active', cursor: 0, nextCursor: null, prevStack: [], page: 1, limit: 25 };
    function fuSetTab(tab){ fuState.tab = tab; fuState.cursor = 0; fuState.prevStack = []; fuState.page = 1; document.getElementById('fu-page').textContent = 'Página 1';
      document.getElementById('fu-tab-active').classList.toggle('btn-tab-active', tab==='active');
      document.getElementById('fu-tab-history').classList.toggle('btn-tab-active', tab==='history');
      loadFullUsers(); }
    async function loadFullUsers(){
      try{
        const q = (document.getElementById('fu-q')?.value||'');
        const onlineOnly = fuState.tab === 'active';
        const url = `/api/admin/users/list?search=${encodeURIComponent(q)}&onlineOnly=${onlineOnly}&limit=${fuState.limit}&cursor=${fuState.cursor}`;
        const resp = await fetch(url);
        const j = await resp.json();
        const rows = document.getElementById('fu-rows'); if (!rows) return;
        rows.innerHTML='';
        const arr = (j && j.items) ? j.items : [];
        fuState.nextCursor = (j && (typeof j.nextCursor !== 'undefined')) ? j.nextCursor : null;
        for (const u of arr){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style=\"font-family:monospace\">${u.telegramId||'-'}</td>
            <td>${u.email||'-'}</td>
            <td style=\"font-family:monospace\">${u.userId||'-'}</td>
            <td>${u.telegramUsername||u.userName||'-'}</td>
            <td>${u.userName||'-'}</td>
            <td>${u.phone||'-'}</td>
            <td><code>${shortTxt(u.lastDevice||'-', 48)}</code></td>
            <td>${fmtTS(u.lastSeenAt)} · ${fmtDur(u.lastDurationMs)}</td>
            <td>${u.email||'-'}</td>
            <td>${fmt(u.fires||0)}</td>
            <td><button class=\"btn btn-small btn-reset\" data-id=\"${u.userId}\">Reset</button></td>
          `;
          rows.appendChild(tr);
        }
        document.getElementById('fu-page').textContent = `Página ${fuState.page}`;
        document.getElementById('fu-prev').disabled = fuState.prevStack.length===0;
        document.getElementById('fu-next').disabled = (fuState.nextCursor===null);
        for (const b of document.querySelectorAll('button.btn-reset')){
          b.addEventListener('click', async (e)=>{
            const id = e.currentTarget.getAttribute('data-id');
            if (!id) return;
            if (!confirm('¿Resetear claves y contacto de este usuario?')) return;
            try{
              const r = await fetch('/api/admin/users/reset', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId:id }) });
              const j = await r.json();
              if (j && j.success) { await loadFullUsers(); }
              else { alert('No se pudo resetear'); }
            }catch(_){ alert('Error de red'); }
          });
        }
      }catch(_){ const rows=document.getElementById('fu-rows'); if(rows) rows.innerHTML='<tr><td colspan=\"11\">Error de red</td></tr>'; }
    }

    async function fetchWelcomeStatus(){
      try{
        const r = await fetch('/api/welcome/status');
        const j = await r.json();
        const statusEl = document.getElementById('wel-status');
        const infoEl = document.getElementById('wel-info');
        if(!(j&&j.success&&j.event)){ statusEl.textContent='—'; infoEl.innerHTML=''; return; }
        const ev = j.event; const now = Date.now();
        const active = !!ev.active && now < Number(ev.endsAt||0);
        statusEl.textContent = active ? 'Activo' : 'Inactivo';
        infoEl.innerHTML = '';
        const mk = (k,v)=>{ const row=document.createElement('div'); row.className='row'; row.innerHTML=`<span class="muted">${k}</span><span>${v}</span>`; infoEl.appendChild(row); };
        mk('Monedas', fmt(ev.coins||0));
        mk('Fuegos', fmt(ev.fires||0));
        mk('Inicio', ev.startsAt? new Date(ev.startsAt).toLocaleString() : '-');
        mk('Fin', ev.endsAt? new Date(ev.endsAt).toLocaleString() : '-');
        mk('Mensaje', ev.message? `<code>${ev.message}</code>` : '-');
        const msgI = document.getElementById('wel-msg'); if (msgI && typeof ev.message==='string') msgI.value = ev.message;
      }catch(_){ document.getElementById('wel-status').textContent='Error'; }
    }

    async function activateWelcome(){
      const coins = parseInt(document.getElementById('wel-coins').value||'0',10)||0;
      const fires = parseInt(document.getElementById('wel-fires').value||'0',10)||0;
      const durationHours = parseInt(document.getElementById('wel-hours').value||'72',10)||72;
      const message = String(document.getElementById('wel-msg').value||'');
      const user = String(document.getElementById('wel-admin-user').value||'');
      const code = String(document.getElementById('wel-admin-code').value||'');
      const alertEl = document.getElementById('wel-alert');
      alertEl.textContent='';
      try{
        const r = await fetch('/api/admin/welcome/activate', {
          method:'POST', headers:{ 'Content-Type':'application/json', 'x-admin-username': user, 'x-admin-code': code }, body: JSON.stringify({ coins, fires, durationHours, message })
        });
        const j = await r.json();
        if (j&&j.success){ alertEl.textContent='Evento activado.'; await fetchWelcomeStatus(); }
        else { alertEl.textContent='Error: '+(j&&j.error||'activate_error'); }
      }catch(e){ alertEl.textContent='Error de red'; }
    }

    async function disableWelcome(){
      const user = String(document.getElementById('wel-admin-user').value||'');
      const code = String(document.getElementById('wel-admin-code').value||'');
      const alertEl = document.getElementById('wel-alert');
      alertEl.textContent='';
      try{
        const r = await fetch('/api/admin/welcome/disable', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-admin-username': user, 'x-admin-code': code } });
        const j = await r.json();
        if (j&&j.success){ alertEl.textContent='Evento desactivado.'; await fetchWelcomeStatus(); }
        else { alertEl.textContent='Error: '+(j&&j.error||'disable_error'); }
      }catch(e){ alertEl.textContent='Error de red'; }
    }
    function startSSE(){
      const es = new EventSource('/api/economy/supply/stream');
      es.addEventListener('supply', (ev) => {
        try { const d = JSON.parse(ev.data); const s=d.value; if(s){ $('total').textContent=fmt(s.total); $('circ').textContent=fmt(s.circulating); $('burn').textContent=fmt(s.burned); const rv=$('reserve'); if(rv) rv.textContent=fmt(s.reserve||0); } } catch(_){ }
      });
    }

    function fmtTS(t){ if(!t) return '-'; try{ return new Date(Number(t)).toLocaleString(); }catch(_){ return '-'; } }
    async function loadAdminUsers(){
      try{
        const q = (document.getElementById('au-q')?.value||'');
        const onlineOnly = !!document.getElementById('au-online')?.checked;
        const r = await fetch(`/api/admin/users/list?search=${encodeURIComponent(q)}&onlineOnly=${onlineOnly}`);
        const j = await r.json();
        const rows = document.getElementById('au-rows');
        rows.innerHTML='';
        const arr = (j && j.items) ? j.items : [];
        for (const u of arr){
          const tr = document.createElement('tr');
          const ok = (u.idMatch===true);
          tr.innerHTML = `
            <td>${fmtTS(u.createdAt)}</td>
            <td>${fmtTS(u.lastSeenAt)}</td>
            <td style="font-family:monospace">${u.userId||'-'}</td>
            <td style="font-family:monospace">${u.telegramId||'-'}</td>
            <td>${u.email||'-'}</td>
            <td>${u.phone||'-'}</td>
            <td>${fmt(u.fires||0)}</td>
            <td style="font-family:monospace">${u.expectedId||'-'}</td>
            <td class="${ok?'ok':'bad'}">${ok?'OK':'NO'}</td>
          `;
          rows.appendChild(tr);
        }
      }catch(_){ const rows=document.getElementById('au-rows'); if(rows) rows.innerHTML='<tr><td colspan="8">Error de red</td></tr>'; }
    }

    async function loadTxs(){
      const r = await fetch('/api/economy/supply/txs?limit=20');
      const j = await r.json();
      const el = $('txs'); el.innerHTML = '';
      const items = j.items || [];
      for(const it of items){
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `<span class="muted">${it.type || 'tx'}</span><span>${fmt(it.amount||0)}</span>`;
        el.appendChild(row);
      }
    }

    async function loadUsers(){
      try{
        const r = await fetch('/api/economy/users?cursor=&limit=10');
        const list = await r.json();
        const el = $('users'); el.innerHTML='';
        (list||[]).forEach(u => {
          const row = document.createElement('div');
          row.className='row';
          const uid = u.userId || u.id || '-';
          row.innerHTML = `<span class="muted">${uid}</span><span>${fmt(u.fires||0)} 🔥</span>`;
          el.appendChild(row);
        });
      } catch(_){ $('users').innerHTML='<div class="row">No data</div>'; }
    }

    async function loadXP(){
      try{
        const r = await fetch('/api/xp/config');
        const j = await r.json();
        const el = $('xp'); el.innerHTML='';
        const th = (j.config && j.config.thresholds) || j.thresholds || {};
        Object.entries(th).forEach(([lvl, pts])=>{
          const row=document.createElement('div'); row.className='row';
          row.innerHTML = `<span class="muted">Nivel ${lvl}</span><span>${fmt(pts)}</span>`;
          el.appendChild(row);
        });
      }catch(_){ $('xp').innerHTML='<div class="row">No data</div>'; }
    }

    loadSupply();
    startSSE();
    loadTxs();
    loadXP();
    loadAdminUsers();
    fetchWelcomeStatus();
    loadFullUsers();
    document.getElementById('wel-refresh').addEventListener('click', fetchWelcomeStatus);
    const applyBtn = document.getElementById('wel-apply'); if (applyBtn) applyBtn.addEventListener('click', activateWelcome);
    document.getElementById('wel-disable').addEventListener('click', disableWelcome);
    if (typeof fetchCircInitStatus === 'function') {
      fetchCircInitStatus();
      const cr=document.getElementById('circ-refresh'); if(cr){ cr.addEventListener('click', fetchCircInitStatus); }
      const ca=document.getElementById('circ-assign'); if(ca){ ca.addEventListener('click', assignInitial); }
      const cc=document.getElementById('circ-reconcile'); if(cc){ cc.addEventListener('click', doReconcile); }
    }
    const aq=document.getElementById('au-q'); if(aq){ aq.addEventListener('keydown', (e)=>{ if(e.key==='Enter') loadAdminUsers(); }); }
    const ao=document.getElementById('au-online'); if(ao){ ao.addEventListener('change', loadAdminUsers); }
    const ar=document.getElementById('au-refresh'); if(ar){ ar.addEventListener('click', loadAdminUsers); }
    const fur=document.getElementById('fu-refresh'); if(fur){ fur.addEventListener('click', ()=>{ fuState.cursor=0; fuState.prevStack=[]; fuState.page=1; loadFullUsers(); }); }
    const fuq=document.getElementById('fu-q'); if(fuq){ fuq.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ fuState.cursor=0; fuState.prevStack=[]; fuState.page=1; loadFullUsers(); } }); }
    const fprev=document.getElementById('fu-prev'); if(fprev){ fprev.addEventListener('click', ()=>{ if (fuState.prevStack.length>0){ fuState.cursor = fuState.prevStack.pop(); fuState.page=Math.max(1, fuState.page-1); loadFullUsers(); } }); }
    const fnext=document.getElementById('fu-next'); if(fnext){ fnext.addEventListener('click', ()=>{ if (fuState.nextCursor!==null){ fuState.prevStack.push(fuState.cursor); fuState.cursor = fuState.nextCursor; fuState.page += 1; loadFullUsers(); } }); }
    const tabA=document.getElementById('fu-tab-active'); if(tabA){ tabA.addEventListener('click', ()=> fuSetTab('active')); }
    const tabH=document.getElementById('fu-tab-history'); if(tabH){ tabH.addEventListener('click', ()=> fuSetTab('history')); }
    setInterval(()=>{ try{ loadAdminUsers(); }catch(_){ } }, 10000);
    setInterval(()=>{ try{ loadFullUsers(); }catch(_){ } }, 15000);
  </script>
  <script src="/js/music.js"></script>
</body>
</html>
