{
  "meta": {
    "proyecto": "Telegram Game Room",
    "version": "v2-profile-stage",
    "fecha": "2025-10-08T00:50:36-04:00",
    "stack": ["Node.js", "Express", "Redis", "Telegram WebApp", "Frontend-v2"]
  },
  "componentes": {
    "frontend_v2": [
      "index.html (pantallas Lobby/Perfil/Rifas/Juego)",
      "css/core.css (temas, microinteracciones, avatar, perfil)",
      "js/core/app.js (nav, perfil P2P, fetch profile)",
      "js/core/ui.js (logs en tiempo real)",
      "js/core/registry.js (plugins)",
      "plugins/bingo, plugins/domino"
    ],
    "dashboard": [
      "frontend/dashboard/index.html",
      "frontend/dashboard/app.js (sponsorPromote)",
      "frontend/dashboard/styles.css"
    ],
    "backend": [
      "backend/server.js (monta /api/profile)",
      "backend/routes/profile.js",
      "backend/services/profileService.js",
      "backend/routes/economy.js (transfer, sponsors)",
      "backend/middleware/adminAuth.js"
    ]
  },
  "endpoints": {
    "perfil": {
      "GET /api/profile/:userId": "Obtiene perfil (firstName,lastName,phone,email) fusionado con User si existe.",
      "POST /api/profile/:userId": "Actualiza campos de perfil (hash user:{id}:profile, TTL session)",
      "POST /api/profile/:userId/request-key-change": "Solicita cambio de clave sponsor (guarda en profile:keyreq:{id})"
    },
    "economia": {
      "POST /api/economy/sponsors/add": "Requiere adminAuth (x-admin-username, x-admin-code)",
      "POST /api/economy/transfer": "Solo sponsors; requiere sponsorKey válida",
      "GET /api/economy/sponsors": "Listado con hasKey y fires"
    }
  },
  "errores_comunes": {
    "E-SP01": {
      "cat": "economia",
      "desc": "Transferencia P2P falla con 403 Clave inválida",
      "causa": "sponsorKey no provista o incorrecta",
      "solucion": "Ingresar clave correcta en Perfil > Enviar tokens"
    },
    "E-SP02": {
      "cat": "economia",
      "desc": "403 Solo patrocinadores pueden transferir",
      "causa": "Usuario no está en economy:sponsors",
      "solucion": "Promover desde Dashboard con ID Telegram y (opcional) grant inicial"
    },
    "E-ADM01": {
      "cat": "admin",
      "desc": "403 No autorizado en /sponsors/add",
      "causa": "adminAuth sin x-admin-username/x-admin-code o valores incorrectos",
      "solucion": "Enviar encabezados o body adminUsername=@wilcnct, adminCode=658072974"
    },
    "E-UI01": {
      "cat": "ui",
      "desc": "Perfil no carga datos remotos",
      "causa": "userId no disponible (WebApp fuera de Telegram)",
      "solucion": "Se usa fallback dev_*, y se guarda localStorage; P2P oculto si no sponsor"
    },
    "E-GIT-CRLF": {
      "cat": "sistema",
      "desc": "Advertencias LF->CRLF en git",
      "causa": "Auto-conversión en Windows",
      "solucion": "Ignorar o configurar core.autocrlf; no afecta ejecución"
    }
  },
  "buenas_practicas": [
    "Logs de UI en tiempo real (UI.ensureLogOverlay)",
    "Btns con estado loading/disabled; feedback inmediato",
    "Rate limit en /api y helmet en server",
    "Evitar '&&' en PowerShell 5.1; usar $LASTEXITCODE"
  ]
}
